 <!doctype html> <html lang="zh" class="no-js"> <head> <meta charset="utf-8"> <meta name="viewport" content="width=device-width,initial-scale=1"> <meta name="description" content="Programming Tech Sharing 是我用来整合知识的一个站点，主要面向编程知识。"> <meta name="author" content="Torres Lei"> <link rel="canonical" href="https://yongqilei.github.io/java/spring-cloud-ribbon/"> <link rel="icon" href="../../favicon.ico"> <meta name="generator" content="mkdocs-1.3.1, mkdocs-material-8.1.4"> <title>Spring Cloud Ribbon 源码解析 - Programming Tech Sharing</title> <link rel="stylesheet" href="../../assets/stylesheets/main.bb3983ee.min.css"> <link rel="stylesheet" href="../../assets/stylesheets/palette.e6a45f82.min.css"> <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin> <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Fira+Sans:300,400,400i,700%7CFira+Mono&display=fallback"> <style>:root{--md-text-font:"Fira Sans";--md-code-font:"Fira Mono"}</style> <script>__md_scope=new URL("../..",location),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script> </head> <body dir="ltr" data-md-color-scheme="" data-md-color-primary="indigo" data-md-color-accent="indigo"> <script>var palette=__md_get("__palette");if(palette&&"object"==typeof palette.color)for(var[key,value]of Object.entries(palette.color))document.body.setAttribute("data-md-color-"+key,value)</script> <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off"> <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off"> <label class="md-overlay" for="__drawer"></label> <div data-md-component="skip"> <a href="#_1" class="md-skip"> 跳转至 </a> </div> <div data-md-component="announce"> </div> <header class="md-header" data-md-component="header"> <nav class="md-header__inner md-grid" aria-label="页眉"> <a href="../.." title="Programming Tech Sharing" class="md-header__button md-logo" aria-label="Programming Tech Sharing" data-md-component="logo"> <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M6 20h7v2H6c-1.11 0-2-.89-2-2V4a2 2 0 0 1 2-2h12a2 2 0 0 1 2 2v8.54l-1.5-.82-.5.28V4h-5v8l-2.5-2.25L8 12V4H6v16m18-3-5.5-3-5.5 3 5.5 3 5.5-3m-9 2.09v2L18.5 23l3.5-1.91v-2L18.5 21 15 19.09z"/></svg> </a> <label class="md-header__button md-icon" for="__drawer"> <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2z"/></svg> </label> <div class="md-header__title" data-md-component="header-title"> <div class="md-header__ellipsis"> <div class="md-header__topic"> <span class="md-ellipsis"> Programming Tech Sharing </span> </div> <div class="md-header__topic" data-md-component="header-topic"> <span class="md-ellipsis"> Spring Cloud Ribbon 源码解析 </span> </div> </div> </div> <form class="md-header__option" data-md-component="palette"> <input class="md-option" data-md-color-media="" data-md-color-scheme="" data-md-color-primary="indigo" data-md-color-accent="indigo" aria-label="Switch to dark mode" type="radio" name="__palette" id="__palette_1"> <label class="md-header__button md-icon" title="Switch to dark mode" for="__palette_2" hidden> <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M17 7H7a5 5 0 0 0-5 5 5 5 0 0 0 5 5h10a5 5 0 0 0 5-5 5 5 0 0 0-5-5m0 8a3 3 0 0 1-3-3 3 3 0 0 1 3-3 3 3 0 0 1 3 3 3 3 0 0 1-3 3z"/></svg> </label> <input class="md-option" data-md-color-media="" data-md-color-scheme="slate" data-md-color-primary="red" data-md-color-accent="red" aria-label="Switch to light mode" type="radio" name="__palette" id="__palette_2"> <label class="md-header__button md-icon" title="Switch to light mode" for="__palette_1" hidden> <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M17 6H7c-3.31 0-6 2.69-6 6s2.69 6 6 6h10c3.31 0 6-2.69 6-6s-2.69-6-6-6zm0 10H7c-2.21 0-4-1.79-4-4s1.79-4 4-4h10c2.21 0 4 1.79 4 4s-1.79 4-4 4zM7 9c-1.66 0-3 1.34-3 3s1.34 3 3 3 3-1.34 3-3-1.34-3-3-3z"/></svg> </label> </form> <label class="md-header__button md-icon" for="__search"> <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5z"/></svg> </label> <div class="md-search" data-md-component="search" role="dialog"> <label class="md-search__overlay" for="__search"></label> <div class="md-search__inner" role="search"> <form class="md-search__form" name="search"> <input class="md-search__input" name="query" aria-label="搜索" placeholder="搜索" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required> <label class="md-search__icon md-icon" for="__search"> <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5z"/></svg> <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg> </label> <nav class="md-search__options" aria-label="查找"> <a href="javascript:void(0)" class="md-search__icon md-icon" aria-label="分享" data-clipboard data-clipboard-text="" data-md-component="search-share" tabindex="-1"> <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M18 16.08c-.76 0-1.44.3-1.96.77L8.91 12.7c.05-.23.09-.46.09-.7 0-.24-.04-.47-.09-.7l7.05-4.11c.54.5 1.25.81 2.04.81a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3c0 .24.04.47.09.7L8.04 9.81C7.5 9.31 6.79 9 6 9a3 3 0 0 0-3 3 3 3 0 0 0 3 3c.79 0 1.5-.31 2.04-.81l7.12 4.15c-.05.21-.08.43-.08.66 0 1.61 1.31 2.91 2.92 2.91 1.61 0 2.92-1.3 2.92-2.91A2.92 2.92 0 0 0 18 16.08z"/></svg> </a> <button type="reset" class="md-search__icon md-icon" aria-label="清空当前内容" tabindex="-1"> <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41z"/></svg> </button> </nav> <div class="md-search__suggest" data-md-component="search-suggest"></div> </form> <div class="md-search__output"> <div class="md-search__scrollwrap" data-md-scrollfix> <div class="md-search-result" data-md-component="search-result"> <div class="md-search-result__meta"> 正在初始化搜索引擎 </div> <ol class="md-search-result__list"></ol> </div> </div> </div> </div> </div> <div class="md-header__source"> <a href="https://github.com/yongqilei/yongqilei.github.io" title="前往仓库" class="md-source" data-md-component="source"> <div class="md-source__icon md-icon"> <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 480 512"><path d="M186.1 328.7c0 20.9-10.9 55.1-36.7 55.1s-36.7-34.2-36.7-55.1 10.9-55.1 36.7-55.1 36.7 34.2 36.7 55.1zM480 278.2c0 31.9-3.2 65.7-17.5 95-37.9 76.6-142.1 74.8-216.7 74.8-75.8 0-186.2 2.7-225.6-74.8-14.6-29-20.2-63.1-20.2-95 0-41.9 13.9-81.5 41.5-113.6-5.2-15.8-7.7-32.4-7.7-48.8 0-21.5 4.9-32.3 14.6-51.8 45.3 0 74.3 9 108.8 36 29-6.9 58.8-10 88.7-10 27 0 54.2 2.9 80.4 9.2 34-26.7 63-35.2 107.8-35.2 9.8 19.5 14.6 30.3 14.6 51.8 0 16.4-2.6 32.7-7.7 48.2 27.5 32.4 39 72.3 39 114.2zm-64.3 50.5c0-43.9-26.7-82.6-73.5-82.6-18.9 0-37 3.4-56 6-14.9 2.3-29.8 3.2-45.1 3.2-15.2 0-30.1-.9-45.1-3.2-18.7-2.6-37-6-56-6-46.8 0-73.5 38.7-73.5 82.6 0 87.8 80.4 101.3 150.4 101.3h48.2c70.3 0 150.6-13.4 150.6-101.3zm-82.6-55.1c-25.8 0-36.7 34.2-36.7 55.1s10.9 55.1 36.7 55.1 36.7-34.2 36.7-55.1-10.9-55.1-36.7-55.1z"/></svg> </div> <div class="md-source__repository"> Programming Space </div> </a> </div> </nav> </header> <div class="md-container" data-md-component="container"> <nav class="md-tabs" aria-label="标签" data-md-component="tabs"> <div class="md-tabs__inner md-grid"> <ul class="md-tabs__list"> <li class="md-tabs__item"> <a href="../.." class="md-tabs__link"> 简介 </a> </li> <li class="md-tabs__item"> <a href="../" class="md-tabs__link md-tabs__link--active"> Java </a> </li> <li class="md-tabs__item"> <a href="../../cloud/" class="md-tabs__link"> 云原生 </a> </li> <li class="md-tabs__item"> <a href="../../algo/leetcode/" class="md-tabs__link"> 算法 </a> </li> <li class="md-tabs__item"> <a href="../../bigdata/" class="md-tabs__link"> 大数据 </a> </li> </ul> </div> </nav> <main class="md-main" data-md-component="main"> <div class="md-main__inner md-grid"> <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation"> <div class="md-sidebar__scrollwrap"> <div class="md-sidebar__inner"> <nav class="md-nav md-nav--primary md-nav--lifted" aria-label="导航栏" data-md-level="0"> <label class="md-nav__title" for="__drawer"> <a href="../.." title="Programming Tech Sharing" class="md-nav__button md-logo" aria-label="Programming Tech Sharing" data-md-component="logo"> <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M6 20h7v2H6c-1.11 0-2-.89-2-2V4a2 2 0 0 1 2-2h12a2 2 0 0 1 2 2v8.54l-1.5-.82-.5.28V4h-5v8l-2.5-2.25L8 12V4H6v16m18-3-5.5-3-5.5 3 5.5 3 5.5-3m-9 2.09v2L18.5 23l3.5-1.91v-2L18.5 21 15 19.09z"/></svg> </a> Programming Tech Sharing </label> <div class="md-nav__source"> <a href="https://github.com/yongqilei/yongqilei.github.io" title="前往仓库" class="md-source" data-md-component="source"> <div class="md-source__icon md-icon"> <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 480 512"><path d="M186.1 328.7c0 20.9-10.9 55.1-36.7 55.1s-36.7-34.2-36.7-55.1 10.9-55.1 36.7-55.1 36.7 34.2 36.7 55.1zM480 278.2c0 31.9-3.2 65.7-17.5 95-37.9 76.6-142.1 74.8-216.7 74.8-75.8 0-186.2 2.7-225.6-74.8-14.6-29-20.2-63.1-20.2-95 0-41.9 13.9-81.5 41.5-113.6-5.2-15.8-7.7-32.4-7.7-48.8 0-21.5 4.9-32.3 14.6-51.8 45.3 0 74.3 9 108.8 36 29-6.9 58.8-10 88.7-10 27 0 54.2 2.9 80.4 9.2 34-26.7 63-35.2 107.8-35.2 9.8 19.5 14.6 30.3 14.6 51.8 0 16.4-2.6 32.7-7.7 48.2 27.5 32.4 39 72.3 39 114.2zm-64.3 50.5c0-43.9-26.7-82.6-73.5-82.6-18.9 0-37 3.4-56 6-14.9 2.3-29.8 3.2-45.1 3.2-15.2 0-30.1-.9-45.1-3.2-18.7-2.6-37-6-56-6-46.8 0-73.5 38.7-73.5 82.6 0 87.8 80.4 101.3 150.4 101.3h48.2c70.3 0 150.6-13.4 150.6-101.3zm-82.6-55.1c-25.8 0-36.7 34.2-36.7 55.1s10.9 55.1 36.7 55.1 36.7-34.2 36.7-55.1-10.9-55.1-36.7-55.1z"/></svg> </div> <div class="md-source__repository"> Programming Space </div> </a> </div> <ul class="md-nav__list" data-md-scrollfix> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_1" type="checkbox" id="__nav_1"> <label class="md-nav__link" for="__nav_1"> 简介 <span class="md-nav__icon md-icon"></span> </label> <nav class="md-nav" aria-label="简介" data-md-level="1"> <label class="md-nav__title" for="__nav_1"> <span class="md-nav__icon md-icon"></span> 简介 </label> <ul class="md-nav__list" data-md-scrollfix> <li class="md-nav__item"> <a href="../.." class="md-nav__link"> Getting Started </a> </li> <li class="md-nav__item"> <a href="../../about/" class="md-nav__link"> 关于我 </a> </li> <li class="md-nav__item"> <a href="../../about-en/" class="md-nav__link"> About Me </a> </li> <li class="md-nav__item"> <a href="../../tags/" class="md-nav__link"> 标签 </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--active md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_2" type="checkbox" id="__nav_2" checked="checked"> <label class="md-nav__link" for="__nav_2"> Java <span class="md-nav__icon md-icon"></span> </label> <nav class="md-nav" aria-label="Java" data-md-level="1"> <label class="md-nav__title" for="__nav_2"> <span class="md-nav__icon md-icon"></span> Java </label> <ul class="md-nav__list" data-md-scrollfix> <li class="md-nav__item"> <a href="../" class="md-nav__link"> Java简介 </a> </li> <li class="md-nav__item"> <a href="../synchronized/" class="md-nav__link"> Synchronized 学习笔记 </a> </li> <li class="md-nav__item"> <a href="../volatile/" class="md-nav__link"> Volatile 学习笔记 </a> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_2_4" type="checkbox" id="__nav_2_4"> <label class="md-nav__link" for="__nav_2_4"> JVM <span class="md-nav__icon md-icon"></span> </label> <nav class="md-nav" aria-label="JVM" data-md-level="2"> <label class="md-nav__title" for="__nav_2_4"> <span class="md-nav__icon md-icon"></span> JVM </label> <ul class="md-nav__list" data-md-scrollfix> <li class="md-nav__item"> <a href="../garbage-collector/" class="md-nav__link"> Java 垃圾收集器 </a> </li> <li class="md-nav__item"> <a href="../jvm-breakdown/" class="md-nav__link"> JVM 内存区域学习笔记 </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--active md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_2_5" type="checkbox" id="__nav_2_5" checked="checked"> <label class="md-nav__link" for="__nav_2_5"> Spring <span class="md-nav__icon md-icon"></span> </label> <nav class="md-nav" aria-label="Spring" data-md-level="2"> <label class="md-nav__title" for="__nav_2_5"> <span class="md-nav__icon md-icon"></span> Spring </label> <ul class="md-nav__list" data-md-scrollfix> <li class="md-nav__item md-nav__item--active"> <input class="md-nav__toggle md-toggle" data-md-toggle="toc" type="checkbox" id="__toc"> <label class="md-nav__link md-nav__link--active" for="__toc"> Spring Cloud Ribbon <span class="md-nav__icon md-icon"></span> </label> <a href="./" class="md-nav__link md-nav__link--active"> Spring Cloud Ribbon </a> <nav class="md-nav md-nav--secondary" aria-label="目录"> <label class="md-nav__title" for="__toc"> <span class="md-nav__icon md-icon"></span> 目录 </label> <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix> <li class="md-nav__item"> <a href="#_1" class="md-nav__link"> 负载均衡初始化 </a> <nav class="md-nav" aria-label="负载均衡初始化"> <ul class="md-nav__list"> <li class="md-nav__item"> <a href="#loadbalancerautoconfiguration" class="md-nav__link"> LoadBalancerAutoConfiguration </a> </li> <li class="md-nav__item"> <a href="#_2" class="md-nav__link"> 拦截器配置 </a> <nav class="md-nav" aria-label="拦截器配置"> <ul class="md-nav__list"> <li class="md-nav__item"> <a href="#loadbalancerinterceptor" class="md-nav__link"> LoadBalancerInterceptor 拦截器 </a> </li> <li class="md-nav__item"> <a href="#retryloadbalancerinterceptor" class="md-nav__link"> RetryLoadBalancerInterceptor 拦截器 </a> </li> </ul> </nav> </li> </ul> </nav> </li> <li class="md-nav__item"> <a href="#loadbalancerclient" class="md-nav__link"> LoadBalancerClient 源码分析 </a> </li> <li class="md-nav__item"> <a href="#dynamicserverlistloadbalancer" class="md-nav__link"> DynamicServerListLoadBalancer </a> <nav class="md-nav" aria-label="DynamicServerListLoadBalancer"> <ul class="md-nav__list"> <li class="md-nav__item"> <a href="#_3" class="md-nav__link"> 成员介绍 </a> </li> <li class="md-nav__item"> <a href="#irule" class="md-nav__link"> IRule </a> </li> <li class="md-nav__item"> <a href="#iping" class="md-nav__link"> IPing </a> </li> <li class="md-nav__item"> <a href="#serverlist" class="md-nav__link"> ServerList </a> </li> <li class="md-nav__item"> <a href="#serverlistfilter" class="md-nav__link"> ServerListFilter </a> </li> </ul> </nav> </li> <li class="md-nav__item"> <a href="#_4" class="md-nav__link"> 源码分析 </a> <nav class="md-nav" aria-label="源码分析"> <ul class="md-nav__list"> <li class="md-nav__item"> <a href="#dynamicserverlistloadbalancer_1" class="md-nav__link"> DynamicServerListLoadBalancer 构造方法 </a> </li> <li class="md-nav__item"> <a href="#restofinit" class="md-nav__link"> restOfInit 执行剩下的初始化操作 </a> </li> <li class="md-nav__item"> <a href="#obtainserversviadiscovery" class="md-nav__link"> obtainServersViaDiscovery </a> </li> <li class="md-nav__item"> <a href="#_5" class="md-nav__link"> 定时任务更新服务器列表和状态 </a> </li> </ul> </nav> </li> <li class="md-nav__item"> <a href="#_6" class="md-nav__link"> 总结 </a> </li> <li class="md-nav__item"> <a href="#ref" class="md-nav__link"> Ref </a> </li> </ul> </nav> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_2_6" type="checkbox" id="__nav_2_6"> <label class="md-nav__link" for="__nav_2_6"> 面试 <span class="md-nav__icon md-icon"></span> </label> <nav class="md-nav" aria-label="面试" data-md-level="2"> <label class="md-nav__title" for="__nav_2_6"> <span class="md-nav__icon md-icon"></span> 面试 </label> <ul class="md-nav__list" data-md-scrollfix> <li class="md-nav__item"> <a href="../interview/bytedance-interview/" class="md-nav__link"> 字节跳动 Java 面试题 </a> </li> </ul> </nav> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_3" type="checkbox" id="__nav_3"> <label class="md-nav__link" for="__nav_3"> 云原生 <span class="md-nav__icon md-icon"></span> </label> <nav class="md-nav" aria-label="云原生" data-md-level="1"> <label class="md-nav__title" for="__nav_3"> <span class="md-nav__icon md-icon"></span> 云原生 </label> <ul class="md-nav__list" data-md-scrollfix> <li class="md-nav__item"> <a href="../../cloud/" class="md-nav__link"> 云原生简介 </a> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_3_2" type="checkbox" id="__nav_3_2"> <label class="md-nav__link" for="__nav_3_2"> Golang <span class="md-nav__icon md-icon"></span> </label> <nav class="md-nav" aria-label="Golang" data-md-level="2"> <label class="md-nav__title" for="__nav_3_2"> <span class="md-nav__icon md-icon"></span> Golang </label> <ul class="md-nav__list" data-md-scrollfix> <li class="md-nav__item"> <a href="../../cloud/golang-basics/" class="md-nav__link"> Golang基础知识 </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_3_3" type="checkbox" id="__nav_3_3"> <label class="md-nav__link" for="__nav_3_3"> Kubernetes <span class="md-nav__icon md-icon"></span> </label> <nav class="md-nav" aria-label="Kubernetes" data-md-level="2"> <label class="md-nav__title" for="__nav_3_3"> <span class="md-nav__icon md-icon"></span> Kubernetes </label> <ul class="md-nav__list" data-md-scrollfix> <li class="md-nav__item"> <a href="../../cloud/kubernetes-on-centos/" class="md-nav__link"> Kubernetes on CentOS </a> </li> <li class="md-nav__item"> <a href="../../cloud/kubernetes-installation-on-centos/" class="md-nav__link"> 在CentOS上安装K8S </a> </li> <li class="md-nav__item"> <a href="../../cloud/kubernetes-java-commands/" class="md-nav__link"> Kubernetes中Java应用相关操作 </a> </li> </ul> </nav> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_4" type="checkbox" id="__nav_4"> <label class="md-nav__link" for="__nav_4"> 算法 <span class="md-nav__icon md-icon"></span> </label> <nav class="md-nav" aria-label="算法" data-md-level="1"> <label class="md-nav__title" for="__nav_4"> <span class="md-nav__icon md-icon"></span> 算法 </label> <ul class="md-nav__list" data-md-scrollfix> <li class="md-nav__item"> <a href="../../algo/leetcode/" class="md-nav__link"> Leetcode刷题记录 </a> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_4_2" type="checkbox" id="__nav_4_2"> <label class="md-nav__link" for="__nav_4_2"> LeetCode <span class="md-nav__icon md-icon"></span> </label> <nav class="md-nav" aria-label="LeetCode" data-md-level="2"> <label class="md-nav__title" for="__nav_4_2"> <span class="md-nav__icon md-icon"></span> LeetCode </label> <ul class="md-nav__list" data-md-scrollfix> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_4_2_1" type="checkbox" id="__nav_4_2_1"> <label class="md-nav__link" for="__nav_4_2_1"> Daily <span class="md-nav__icon md-icon"></span> </label> <nav class="md-nav" aria-label="Daily" data-md-level="3"> <label class="md-nav__title" for="__nav_4_2_1"> <span class="md-nav__icon md-icon"></span> Daily </label> <ul class="md-nav__list" data-md-scrollfix> <li class="md-nav__item"> <a href="../../algo/leetcode/daily/2022-01-04/" class="md-nav__link"> 2022/01/04 - 913. 猫和老鼠 </a> </li> <li class="md-nav__item"> <a href="../../algo/leetcode/daily/2022-01-05/" class="md-nav__link"> 2021/01/05 - 1576. 替换所有的问号 </a> </li> <li class="md-nav__item"> <a href="../../algo/leetcode/daily/2022-01-07/" class="md-nav__link"> 2022/01/07 - 1614. 括号的最大嵌套深度 </a> </li> <li class="md-nav__item"> <a href="../../algo/leetcode/daily/2022-01-07-en/" class="md-nav__link"> 2022/01/07 - 382. Linked List Random Node </a> </li> <li class="md-nav__item"> <a href="../../algo/leetcode/daily/2022-01-08/" class="md-nav__link"> 2022/01/08 - 89. 格雷编码 </a> </li> <li class="md-nav__item"> <a href="../../algo/leetcode/daily/2022-01-09-en/" class="md-nav__link"> 2022/01/09 - 1041. Robot Bounded In Circle </a> </li> <li class="md-nav__item"> <a href="../../algo/leetcode/daily/2022-01-09/" class="md-nav__link"> 2022/01/09 - 1629. 按键持续时间最长的键 </a> </li> <li class="md-nav__item"> <a href="../../algo/leetcode/daily/2022-01-10/" class="md-nav__link"> 2022/01/10 - 306. 累加数 </a> </li> <li class="md-nav__item"> <a href="../../algo/leetcode/daily/2022-01-11/" class="md-nav__link"> 2022/01/11 - 1036. 逃离大迷宫 </a> </li> <li class="md-nav__item"> <a href="../../algo/leetcode/daily/2022-01-12-en/" class="md-nav__link"> 2022/01/12 - 701. Insert into a Binary Search Tree </a> </li> <li class="md-nav__item"> <a href="../../algo/leetcode/daily/2022-01-13/" class="md-nav__link"> 2022/01/13 - 747. 至少是其他数字两倍的最大数 </a> </li> <li class="md-nav__item"> <a href="../../algo/leetcode/daily/2022-01-14/" class="md-nav__link"> 2022/01/14 - 373. 查找和最小的 K 对数字 </a> </li> <li class="md-nav__item"> <a href="../../algo/leetcode/daily/2022-01-15-en/" class="md-nav__link"> 2022/01/15 - 1345. Jump Game IV </a> </li> <li class="md-nav__item"> <a href="../../algo/leetcode/daily/2022-01-15/" class="md-nav__link"> 2022/01/15 - 1716. 计算力扣银行的钱 </a> </li> <li class="md-nav__item"> <a href="../../algo/leetcode/daily/2022-01-16/" class="md-nav__link"> 2022/01/16 - 849. Maximize Distance to Closest Person </a> </li> <li class="md-nav__item"> <a href="../../algo/leetcode/daily/2022-01-17/" class="md-nav__link"> 2022/01/17 - 290. Word Pattern </a> </li> <li class="md-nav__item"> <a href="../../algo/leetcode/daily/2022-01-20/" class="md-nav__link"> 2022/01/20 - 875. Koko Eating Bananas </a> </li> <li class="md-nav__item"> <a href="../../algo/leetcode/daily/2022-01-21/" class="md-nav__link"> 2022/01/20 - 134. Gas Station </a> </li> <li class="md-nav__item"> <a href="../../algo/leetcode/daily/2022-01-26/" class="md-nav__link"> 2022/01/26 - 1305. All Elements in Two Binary Search Trees </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_4_2_2" type="checkbox" id="__nav_4_2_2"> <label class="md-nav__link" for="__nav_4_2_2"> 动态规划 <span class="md-nav__icon md-icon"></span> </label> <nav class="md-nav" aria-label="动态规划" data-md-level="3"> <label class="md-nav__title" for="__nav_4_2_2"> <span class="md-nav__icon md-icon"></span> 动态规划 </label> <ul class="md-nav__list" data-md-scrollfix> <li class="md-nav__item"> <a href="../../algo/leetcode/dp/188-best-time-to-buy-and-sell-stock-iv/" class="md-nav__link"> 188. 买卖股票的最佳时机 IV </a> </li> <li class="md-nav__item"> <a href="../../algo/leetcode/dp/309-best-time-to-buy-and-sell-stock-with-cooldown/" class="md-nav__link"> 309. 最佳买卖股票时机含冷冻期 </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_4_2_3" type="checkbox" id="__nav_4_2_3"> <label class="md-nav__link" for="__nav_4_2_3"> 字符串系列 <span class="md-nav__icon md-icon"></span> </label> <nav class="md-nav" aria-label="字符串系列" data-md-level="3"> <label class="md-nav__title" for="__nav_4_2_3"> <span class="md-nav__icon md-icon"></span> 字符串系列 </label> <ul class="md-nav__list" data-md-scrollfix> <li class="md-nav__item"> <a href="../../algo/leetcode/string/string-to-integer-atoi/" class="md-nav__link"> 8. String to Integer (atoi) </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_4_2_4" type="checkbox" id="__nav_4_2_4"> <label class="md-nav__link" for="__nav_4_2_4"> 树系列 <span class="md-nav__icon md-icon"></span> </label> <nav class="md-nav" aria-label="树系列" data-md-level="3"> <label class="md-nav__title" for="__nav_4_2_4"> <span class="md-nav__icon md-icon"></span> 树系列 </label> <ul class="md-nav__list" data-md-scrollfix> <li class="md-nav__item"> <a href="../../algo/leetcode/tree/98-validate-binary-search-tree/" class="md-nav__link"> 98. Validate Binary Search Tree </a> </li> <li class="md-nav__item"> <a href="../../algo/leetcode/tree/102-binary-tree-level-order-traversal/" class="md-nav__link"> 102. Binary Tree Level Order Traversal </a> </li> <li class="md-nav__item"> <a href="../../algo/leetcode/tree/103-binary-tree-zigzag-level-order-traversal/" class="md-nav__link"> 103. Binary Tree Zigzag Level Order Traversal </a> </li> <li class="md-nav__item"> <a href="../../algo/leetcode/tree/107-binary-tree-level-order-traversal-ii/" class="md-nav__link"> 107. Binary Tree Level Order Traversal II </a> </li> <li class="md-nav__item"> <a href="../../algo/leetcode/tree/701-insert-into-a-binary-search-tree/" class="md-nav__link"> 701. Insert into a Binary Search Tree </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_4_2_5" type="checkbox" id="__nav_4_2_5"> <label class="md-nav__link" for="__nav_4_2_5"> 二分查找系列 <span class="md-nav__icon md-icon"></span> </label> <nav class="md-nav" aria-label="二分查找系列" data-md-level="3"> <label class="md-nav__title" for="__nav_4_2_5"> <span class="md-nav__icon md-icon"></span> 二分查找系列 </label> <ul class="md-nav__list" data-md-scrollfix> <li class="md-nav__item"> <a href="../../algo/leetcode/binary-search/33-search-in-rotated-sorted-array/" class="md-nav__link"> 33. Search in Rotated Sorted Array </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_4_2_6" type="checkbox" id="__nav_4_2_6"> <label class="md-nav__link" for="__nav_4_2_6"> 回溯系列 <span class="md-nav__icon md-icon"></span> </label> <nav class="md-nav" aria-label="回溯系列" data-md-level="3"> <label class="md-nav__title" for="__nav_4_2_6"> <span class="md-nav__icon md-icon"></span> 回溯系列 </label> <ul class="md-nav__list" data-md-scrollfix> <li class="md-nav__item"> <a href="../../algo/leetcode/backtrack/22-generate-parentheses/" class="md-nav__link"> 22. Generate Parentheses </a> </li> <li class="md-nav__item"> <a href="../../algo/leetcode/backtrack/17-letter-combination-of-a-phone-number/" class="md-nav__link"> 17. Letter Combinations of a Phone Number </a> </li> </ul> </nav> </li> <li class="md-nav__item"> <a href="../../algo/leetcode/number-of-islands/" class="md-nav__link"> 200. 岛屿数量 </a> </li> <li class="md-nav__item"> <a href="../../algo/leetcode/check-completeness-of-a-binary-tree/" class="md-nav__link"> 958. Check Completeness of a Binary Tree </a> </li> <li class="md-nav__item"> <a href="../../algo/leetcode/rotate-image-48/" class="md-nav__link"> 48. Rotate Image </a> </li> <li class="md-nav__item"> <a href="../../algo/leetcode/142-linked-list-cycle-ii/" class="md-nav__link"> 142. Linked List Cycle II </a> </li> <li class="md-nav__item"> <a href="../../algo/leetcode/string/6-zigzag-conversion/" class="md-nav__link"> 6. Zigzag Conversion </a> </li> </ul> </nav> </li> <li class="md-nav__item"> <a href="../../algo/union-find/" class="md-nav__link"> 并查集 </a> </li> <li class="md-nav__item"> <a href="../../algo/manacher-palindrome/" class="md-nav__link"> Manacher算法 </a> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_4_5" type="checkbox" id="__nav_4_5"> <label class="md-nav__link" for="__nav_4_5"> 排序算法 <span class="md-nav__icon md-icon"></span> </label> <nav class="md-nav" aria-label="排序算法" data-md-level="2"> <label class="md-nav__title" for="__nav_4_5"> <span class="md-nav__icon md-icon"></span> 排序算法 </label> <ul class="md-nav__list" data-md-scrollfix> <li class="md-nav__item"> <a href="../../algo/selection-sort/" class="md-nav__link"> 选择排序 </a> </li> <li class="md-nav__item"> <a href="../../algo/insertion-sort/" class="md-nav__link"> 插入排序 </a> </li> <li class="md-nav__item"> <a href="../../algo/shell-sort/" class="md-nav__link"> 希尔排序 </a> </li> <li class="md-nav__item"> <a href="../../algo/merge-sort/" class="md-nav__link"> 归并排序 </a> </li> </ul> </nav> </li> <li class="md-nav__item"> <a href="../../algo/rabin-karp-algo/" class="md-nav__link"> Rabin Karp Algorithm - 字符串哈希算法 </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_5" type="checkbox" id="__nav_5"> <label class="md-nav__link" for="__nav_5"> 大数据 <span class="md-nav__icon md-icon"></span> </label> <nav class="md-nav" aria-label="大数据" data-md-level="1"> <label class="md-nav__title" for="__nav_5"> <span class="md-nav__icon md-icon"></span> 大数据 </label> <ul class="md-nav__list" data-md-scrollfix> <li class="md-nav__item"> <a href="../../bigdata/" class="md-nav__link"> 简介 </a> </li> <li class="md-nav__item"> <a href="../../bigdata/scala-basics/" class="md-nav__link"> Scala 基础知识学习笔记 </a> </li> </ul> </nav> </li> </ul> </nav> </div> </div> </div> <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc"> <div class="md-sidebar__scrollwrap"> <div class="md-sidebar__inner"> <nav class="md-nav md-nav--secondary" aria-label="目录"> <label class="md-nav__title" for="__toc"> <span class="md-nav__icon md-icon"></span> 目录 </label> <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix> <li class="md-nav__item"> <a href="#_1" class="md-nav__link"> 负载均衡初始化 </a> <nav class="md-nav" aria-label="负载均衡初始化"> <ul class="md-nav__list"> <li class="md-nav__item"> <a href="#loadbalancerautoconfiguration" class="md-nav__link"> LoadBalancerAutoConfiguration </a> </li> <li class="md-nav__item"> <a href="#_2" class="md-nav__link"> 拦截器配置 </a> <nav class="md-nav" aria-label="拦截器配置"> <ul class="md-nav__list"> <li class="md-nav__item"> <a href="#loadbalancerinterceptor" class="md-nav__link"> LoadBalancerInterceptor 拦截器 </a> </li> <li class="md-nav__item"> <a href="#retryloadbalancerinterceptor" class="md-nav__link"> RetryLoadBalancerInterceptor 拦截器 </a> </li> </ul> </nav> </li> </ul> </nav> </li> <li class="md-nav__item"> <a href="#loadbalancerclient" class="md-nav__link"> LoadBalancerClient 源码分析 </a> </li> <li class="md-nav__item"> <a href="#dynamicserverlistloadbalancer" class="md-nav__link"> DynamicServerListLoadBalancer </a> <nav class="md-nav" aria-label="DynamicServerListLoadBalancer"> <ul class="md-nav__list"> <li class="md-nav__item"> <a href="#_3" class="md-nav__link"> 成员介绍 </a> </li> <li class="md-nav__item"> <a href="#irule" class="md-nav__link"> IRule </a> </li> <li class="md-nav__item"> <a href="#iping" class="md-nav__link"> IPing </a> </li> <li class="md-nav__item"> <a href="#serverlist" class="md-nav__link"> ServerList </a> </li> <li class="md-nav__item"> <a href="#serverlistfilter" class="md-nav__link"> ServerListFilter </a> </li> </ul> </nav> </li> <li class="md-nav__item"> <a href="#_4" class="md-nav__link"> 源码分析 </a> <nav class="md-nav" aria-label="源码分析"> <ul class="md-nav__list"> <li class="md-nav__item"> <a href="#dynamicserverlistloadbalancer_1" class="md-nav__link"> DynamicServerListLoadBalancer 构造方法 </a> </li> <li class="md-nav__item"> <a href="#restofinit" class="md-nav__link"> restOfInit 执行剩下的初始化操作 </a> </li> <li class="md-nav__item"> <a href="#obtainserversviadiscovery" class="md-nav__link"> obtainServersViaDiscovery </a> </li> <li class="md-nav__item"> <a href="#_5" class="md-nav__link"> 定时任务更新服务器列表和状态 </a> </li> </ul> </nav> </li> <li class="md-nav__item"> <a href="#_6" class="md-nav__link"> 总结 </a> </li> <li class="md-nav__item"> <a href="#ref" class="md-nav__link"> Ref </a> </li> </ul> </nav> </div> </div> </div> <div class="md-content" data-md-component="content"> <article class="md-content__inner md-typeset"> <a href="https://github.com/yongqilei/yongqilei.github.io/edit/master/docs/java/spring-cloud-ribbon.md" title="编辑此页" class="md-content__button md-icon"> <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20.71 7.04c.39-.39.39-1.04 0-1.41l-2.34-2.34c-.37-.39-1.02-.39-1.41 0l-1.84 1.83 3.75 3.75M3 17.25V21h3.75L17.81 9.93l-3.75-3.75L3 17.25z"/></svg> </a> <h1>Spring Cloud Ribbon</h1> <p>Ribbon 是 Netflix 公司开源的一个负载均衡项目。可以在 Zuul 中使用 Ribbon 做负载均衡，也可以和 Feign 结合使用。在 Spring Cloud 开发中使用的最多的可能就是 RestTemplate 和 Ribbon。代码可能如下：</p> <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1</span>
<span class="normal">2</span>
<span class="normal">3</span>
<span class="normal">4</span>
<span class="normal">5</span>
<span class="normal">6</span>
<span class="normal">7</span>
<span class="normal">8</span></pre></div><td class="code"><div><pre><span></span><code><span class="nd">@Configuration</span><span class="w"></span>
<span class="kd">public</span><span class="w"> </span><span class="kd">class</span> <span class="nc">RibbonConfig</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="nd">@Bean</span><span class="w"></span>
<span class="w">    </span><span class="nd">@LoadBalanced</span><span class="w"></span>
<span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="n">RestTemplate</span><span class="w"> </span><span class="nf">restTemplate</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">RestTemplate</span><span class="p">();</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div></table></div> <p>使用 RestTemplate 消费服务接口的代码可能是这样的：</p> <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1</span>
<span class="normal">2</span>
<span class="normal">3</span>
<span class="normal">4</span>
<span class="normal">5</span>
<span class="normal">6</span>
<span class="normal">7</span>
<span class="normal">8</span>
<span class="normal">9</span></pre></div><td class="code"><div><pre><span></span><code><span class="nd">@Service</span><span class="w"></span>
<span class="kd">public</span><span class="w"> </span><span class="kd">class</span> <span class="nc">RibbonService</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="nd">@Autowired</span><span class="w"></span>
<span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="n">RestTemplate</span><span class="w"> </span><span class="n">restTemplate</span><span class="p">;</span><span class="w"></span>

<span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="nf">hi</span><span class="p">(</span><span class="n">String</span><span class="w"> </span><span class="n">name</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">restTemplate</span><span class="p">.</span><span class="na">getForObject</span><span class="p">(</span><span class="s">&quot;http://eureka-client/hi?name=&quot;</span><span class="o">+</span><span class="n">name</span><span class="p">,</span><span class="n">String</span><span class="p">.</span><span class="na">class</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div></table></div> <p>RestTemplate 在 Spring 中就已经存在了，查看以上的代码可以发现 RestTemplate Bean 上有一个 @LoadBalanced 注解，这个注解标记在 RestTemplate 上，让负载均衡客户端 LoadBalancerClient 来配置它。</p> <h2 id="_1">负载均衡初始化<a class="headerlink" href="#_1" title="Permanent link">&para;</a></h2> <p>spring-cloud-commons 包中定义了 <strong>LoadBalancerClient</strong> 接口，它是 Ribbon 中一个非常重要的组件。继承结构如下：</p> <p><img alt="LoadBalancerClient 继承结构" src="../images/spring-cloud-ribbon/ribbon1.png"></p> <h3 id="loadbalancerautoconfiguration">LoadBalancerAutoConfiguration<a class="headerlink" href="#loadbalancerautoconfiguration" title="Permanent link">&para;</a></h3> <p>而在 spring-cloud-commons 中相同的包下面，可以看到 LoadBalancerAutoConfiguration，看类名就能看出来这是一个自动配置类，会在启动时自动加载其中的配置：</p> <p><img alt="LoadBalancerAutoConfiguration" src="../images/spring-cloud-ribbon/ribbon2.png"></p> <p><strong>LoadBalancerAutoConfiguration</strong></p> <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1</span>
<span class="normal">2</span>
<span class="normal">3</span>
<span class="normal">4</span>
<span class="normal">5</span>
<span class="normal">6</span>
<span class="normal">7</span></pre></div><td class="code"><div><pre><span></span><code><span class="nd">@Configuration</span><span class="w"></span>
<span class="nd">@ConditionalOnClass</span><span class="p">(</span><span class="n">RestTemplate</span><span class="p">.</span><span class="na">class</span><span class="p">)</span><span class="w"></span>
<span class="nd">@ConditionalOnBean</span><span class="p">(</span><span class="n">LoadBalancerClient</span><span class="p">.</span><span class="na">class</span><span class="p">)</span><span class="w"></span>
<span class="nd">@EnableConfigurationProperties</span><span class="p">(</span><span class="n">LoadBalancerRetryProperties</span><span class="p">.</span><span class="na">class</span><span class="p">)</span><span class="w"></span>
<span class="kd">public</span><span class="w"> </span><span class="kd">class</span> <span class="nc">LoadBalancerAutoConfiguration</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="c1">// 省略代码。。。主要是对 LoadBalancerInterceptor 和 RetryLoadBalancerInterCeptor 的等进行配置，这里我们看类上的注解@ConditionalOnBean和@ConditionalOnClass</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div></table></div> <p>可以看到该自动配置类上有注解 <code>@ConditionalOnBean(LoadBalancerClient.class)</code> 和 <code>@ConditionalOnClass(RestTemplate.class)</code>，也就是说此类的生效条件是：</p> <blockquote> <p>1、当前工程中要有 RestTemplate 类</p> <p>2、在 Spring 的 IOC 容器中必须要有 LoadBalancerClient 的实现 Bean</p> </blockquote> <p>然后我们看到 <code>org.springframework.cloud.netflix.ribbon</code> 这个包，其中有一个 <code>RibbonAutoConfiguration.java</code> 类（继承于 LoadBalancerClient）。查看到其中配置的 Bean，我们可以发现，只要引入了这个包，就一定会创建一个 RibbonLoadBalancerClient 实例对象加入到 IOC 容器中，并且触发 <strong>LoadBalancerAutoConfiguration</strong> 配置。</p> <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 1</span>
<span class="normal"> 2</span>
<span class="normal"> 3</span>
<span class="normal"> 4</span>
<span class="normal"> 5</span>
<span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span>
<span class="normal">13</span>
<span class="normal">14</span>
<span class="normal">15</span>
<span class="normal">16</span>
<span class="normal">17</span>
<span class="normal">18</span></pre></div><td class="code"><div><pre><span></span><code><span class="nd">@Configuration</span><span class="w"></span>
<span class="nd">@Conditional</span><span class="p">(</span><span class="n">RibbonAutoConfiguration</span><span class="p">.</span><span class="na">RibbonClassesConditions</span><span class="p">.</span><span class="na">class</span><span class="p">)</span><span class="w"></span>
<span class="nd">@RibbonClients</span><span class="w"></span>
<span class="nd">@AutoConfigureAfter</span><span class="p">(</span><span class="w"></span>
<span class="w">        </span><span class="n">name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;org.springframework.cloud.netflix.eureka.EurekaClientAutoConfiguration&quot;</span><span class="p">)</span><span class="w"></span>
<span class="nd">@AutoConfigureBefore</span><span class="p">({</span><span class="w"> </span><span class="n">LoadBalancerAutoConfiguration</span><span class="p">.</span><span class="na">class</span><span class="p">,</span><span class="w"></span>
<span class="w">        </span><span class="n">AsyncLoadBalancerAutoConfiguration</span><span class="p">.</span><span class="na">class</span><span class="w"> </span><span class="p">})</span><span class="w"></span>
<span class="nd">@EnableConfigurationProperties</span><span class="p">({</span><span class="w"> </span><span class="n">RibbonEagerLoadProperties</span><span class="p">.</span><span class="na">class</span><span class="p">,</span><span class="w"></span>
<span class="w">        </span><span class="n">ServerIntrospectorProperties</span><span class="p">.</span><span class="na">class</span><span class="w"> </span><span class="p">})</span><span class="w"></span>
<span class="kd">public</span><span class="w"> </span><span class="kd">class</span> <span class="nc">RibbonAutoConfiguration</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="c1">// 省略。。。</span><span class="w"></span>
<span class="w">    </span><span class="nd">@Bean</span><span class="w"></span>
<span class="w">    </span><span class="nd">@ConditionalOnMissingBean</span><span class="p">(</span><span class="n">LoadBalancerClient</span><span class="p">.</span><span class="na">class</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="n">LoadBalancerClient</span><span class="w"> </span><span class="nf">loadBalancerClient</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">RibbonLoadBalancerClient</span><span class="p">(</span><span class="n">springClientFactory</span><span class="p">());</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="c1">// 省略。。。</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div></table></div> <p>我们再看回 LoadBalancerAutoConfiguration，该自动化配置类，主要做了几个配置：</p> <p>1、维护了一个被 @LoadBalanced 注解修饰的 <strong>RestTemplate 对象列表</strong></p> <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 1</span>
<span class="normal"> 2</span>
<span class="normal"> 3</span>
<span class="normal"> 4</span>
<span class="normal"> 5</span>
<span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span></pre></div><td class="code"><div><pre><span></span><code><span class="nd">@Configuration</span><span class="w"></span>
<span class="nd">@ConditionalOnClass</span><span class="p">(</span><span class="n">RestTemplate</span><span class="p">.</span><span class="na">class</span><span class="p">)</span><span class="w"></span>
<span class="nd">@ConditionalOnBean</span><span class="p">(</span><span class="n">LoadBalancerClient</span><span class="p">.</span><span class="na">class</span><span class="p">)</span><span class="w"></span>
<span class="nd">@EnableConfigurationProperties</span><span class="p">(</span><span class="n">LoadBalancerRetryProperties</span><span class="p">.</span><span class="na">class</span><span class="p">)</span><span class="w"></span>
<span class="kd">public</span><span class="w"> </span><span class="kd">class</span> <span class="nc">LoadBalancerAutoConfiguration</span><span class="w"> </span><span class="p">{</span><span class="w"></span>

<span class="w">    </span><span class="nd">@LoadBalanced</span><span class="w"></span>
<span class="w">    </span><span class="nd">@Autowired</span><span class="p">(</span><span class="n">required</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">false</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="n">List</span><span class="o">&lt;</span><span class="n">RestTemplate</span><span class="o">&gt;</span><span class="w"> </span><span class="n">restTemplates</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Collections</span><span class="p">.</span><span class="na">emptyList</span><span class="p">();</span><span class="w"></span>
<span class="w">    </span><span class="c1">// ...</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div></table></div> <p>2、为每个对象通过调用 RestTemplateCustomizer 添加了一个 <code>LoadBalancerInterceptor</code> 和 <code>RetryLoadBalancerInterceptor</code> 拦截器。他们都是 ClientHttpRequestInterceptor 接口的实现类，<code>ClientHttpRequestInterceptor</code> 是 <code>RestTemplate</code> 的请求拦截器。</p> <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 1</span>
<span class="normal"> 2</span>
<span class="normal"> 3</span>
<span class="normal"> 4</span>
<span class="normal"> 5</span>
<span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span></pre></div><td class="code"><div><pre><span></span><code><span class="nd">@Bean</span><span class="w"></span>
<span class="kd">public</span><span class="w"> </span><span class="n">SmartInitializingSingleton</span><span class="w"> </span><span class="nf">loadBalancedRestTemplateInitializerDeprecated</span><span class="p">(</span><span class="w"></span>
<span class="w">        </span><span class="kd">final</span><span class="w"> </span><span class="n">ObjectProvider</span><span class="o">&lt;</span><span class="n">List</span><span class="o">&lt;</span><span class="n">RestTemplateCustomizer</span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="n">restTemplateCustomizers</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">restTemplateCustomizers</span><span class="p">.</span><span class="na">ifAvailable</span><span class="p">(</span><span class="n">customizers</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">RestTemplate</span><span class="w"> </span><span class="n">restTemplate</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="n">LoadBalancerAutoConfiguration</span><span class="p">.</span><span class="na">this</span><span class="p">.</span><span class="na">restTemplates</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">            </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">RestTemplateCustomizer</span><span class="w"> </span><span class="n">customizer</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="n">customizers</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">                </span><span class="n">customizer</span><span class="p">.</span><span class="na">customize</span><span class="p">(</span><span class="n">restTemplate</span><span class="p">);</span><span class="w"></span>
<span class="w">            </span><span class="p">}</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="p">});</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div></table></div> <h3 id="_2">拦截器配置<a class="headerlink" href="#_2" title="Permanent link">&para;</a></h3> <h4 id="loadbalancerinterceptor">LoadBalancerInterceptor 拦截器<a class="headerlink" href="#loadbalancerinterceptor" title="Permanent link">&para;</a></h4> <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 1</span>
<span class="normal"> 2</span>
<span class="normal"> 3</span>
<span class="normal"> 4</span>
<span class="normal"> 5</span>
<span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span>
<span class="normal">13</span>
<span class="normal">14</span>
<span class="normal">15</span>
<span class="normal">16</span>
<span class="normal">17</span>
<span class="normal">18</span>
<span class="normal">19</span>
<span class="normal">20</span>
<span class="normal">21</span>
<span class="normal">22</span>
<span class="normal">23</span>
<span class="normal">24</span>
<span class="normal">25</span></pre></div><td class="code"><div><pre><span></span><code><span class="c1">// LoadBalancerAutoconfiguration.java</span><span class="w"></span>
<span class="nd">@Configuration</span><span class="w"></span>
<span class="nd">@ConditionalOnMissingClass</span><span class="p">(</span><span class="s">&quot;org.springframework.retry.support.RetryTemplate&quot;</span><span class="p">)</span><span class="w"></span>
<span class="kd">static</span><span class="w"> </span><span class="kd">class</span> <span class="nc">LoadBalancerInterceptorConfig</span><span class="w"> </span><span class="p">{</span><span class="w"></span>

<span class="w">    </span><span class="nd">@Bean</span><span class="w"></span>
<span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="n">LoadBalancerInterceptor</span><span class="w"> </span><span class="nf">ribbonInterceptor</span><span class="p">(</span><span class="w"></span>
<span class="w">            </span><span class="n">LoadBalancerClient</span><span class="w"> </span><span class="n">loadBalancerClient</span><span class="p">,</span><span class="w"></span>
<span class="w">            </span><span class="n">LoadBalancerRequestFactory</span><span class="w"> </span><span class="n">requestFactory</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">LoadBalancerInterceptor</span><span class="p">(</span><span class="n">loadBalancerClient</span><span class="p">,</span><span class="w"> </span><span class="n">requestFactory</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>

<span class="w">    </span><span class="nd">@Bean</span><span class="w"></span>
<span class="w">    </span><span class="nd">@ConditionalOnMissingBean</span><span class="w"></span>
<span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="n">RestTemplateCustomizer</span><span class="w"> </span><span class="nf">restTemplateCustomizer</span><span class="p">(</span><span class="w"></span>
<span class="w">            </span><span class="kd">final</span><span class="w"> </span><span class="n">LoadBalancerInterceptor</span><span class="w"> </span><span class="n">loadBalancerInterceptor</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">restTemplate</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">            </span><span class="c1">// 此处可见 LoadBalancerInterceptor 是 ClientHttpRequestInterceptor 的实现类</span><span class="w"></span>
<span class="w">            </span><span class="n">List</span><span class="o">&lt;</span><span class="n">ClientHttpRequestInterceptor</span><span class="o">&gt;</span><span class="w"> </span><span class="n">list</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">ArrayList</span><span class="o">&lt;&gt;</span><span class="p">(</span><span class="w"></span>
<span class="w">                    </span><span class="n">restTemplate</span><span class="p">.</span><span class="na">getInterceptors</span><span class="p">());</span><span class="w"></span>
<span class="w">            </span><span class="n">list</span><span class="p">.</span><span class="na">add</span><span class="p">(</span><span class="n">loadBalancerInterceptor</span><span class="p">);</span><span class="w"></span>
<span class="w">            </span><span class="n">restTemplate</span><span class="p">.</span><span class="na">setInterceptors</span><span class="p">(</span><span class="n">list</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="p">};</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div></table></div> <h4 id="retryloadbalancerinterceptor">RetryLoadBalancerInterceptor 拦截器<a class="headerlink" href="#retryloadbalancerinterceptor" title="Permanent link">&para;</a></h4> <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 1</span>
<span class="normal"> 2</span>
<span class="normal"> 3</span>
<span class="normal"> 4</span>
<span class="normal"> 5</span>
<span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span>
<span class="normal">13</span>
<span class="normal">14</span>
<span class="normal">15</span>
<span class="normal">16</span>
<span class="normal">17</span>
<span class="normal">18</span>
<span class="normal">19</span>
<span class="normal">20</span>
<span class="normal">21</span>
<span class="normal">22</span>
<span class="normal">23</span>
<span class="normal">24</span>
<span class="normal">25</span>
<span class="normal">26</span>
<span class="normal">27</span>
<span class="normal">28</span>
<span class="normal">29</span></pre></div><td class="code"><div><pre><span></span><code><span class="nd">@Configuration</span><span class="w"></span>
<span class="nd">@ConditionalOnClass</span><span class="p">(</span><span class="n">RetryTemplate</span><span class="p">.</span><span class="na">class</span><span class="p">)</span><span class="w"></span>
<span class="kd">public</span><span class="w"> </span><span class="kd">static</span><span class="w"> </span><span class="kd">class</span> <span class="nc">RetryInterceptorAutoConfiguration</span><span class="w"> </span><span class="p">{</span><span class="w"></span>

<span class="w">    </span><span class="nd">@Bean</span><span class="w"></span>
<span class="w">    </span><span class="nd">@ConditionalOnMissingBean</span><span class="w"></span>
<span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="n">RetryLoadBalancerInterceptor</span><span class="w"> </span><span class="nf">ribbonInterceptor</span><span class="p">(</span><span class="w"></span>
<span class="w">            </span><span class="n">LoadBalancerClient</span><span class="w"> </span><span class="n">loadBalancerClient</span><span class="p">,</span><span class="w"></span>
<span class="w">            </span><span class="n">LoadBalancerRetryProperties</span><span class="w"> </span><span class="n">properties</span><span class="p">,</span><span class="w"></span>
<span class="w">            </span><span class="n">LoadBalancerRequestFactory</span><span class="w"> </span><span class="n">requestFactory</span><span class="p">,</span><span class="w"></span>
<span class="w">            </span><span class="n">LoadBalancedRetryFactory</span><span class="w"> </span><span class="n">loadBalancedRetryFactory</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">RetryLoadBalancerInterceptor</span><span class="p">(</span><span class="n">loadBalancerClient</span><span class="p">,</span><span class="w"> </span><span class="n">properties</span><span class="p">,</span><span class="w"></span>
<span class="w">                </span><span class="n">requestFactory</span><span class="p">,</span><span class="w"> </span><span class="n">loadBalancedRetryFactory</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>

<span class="w">    </span><span class="nd">@Bean</span><span class="w"></span>
<span class="w">    </span><span class="nd">@ConditionalOnMissingBean</span><span class="w"></span>
<span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="n">RestTemplateCustomizer</span><span class="w"> </span><span class="nf">restTemplateCustomizer</span><span class="p">(</span><span class="w"></span>
<span class="w">            </span><span class="kd">final</span><span class="w"> </span><span class="n">RetryLoadBalancerInterceptor</span><span class="w"> </span><span class="n">loadBalancerInterceptor</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">restTemplate</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">            </span><span class="c1">// RetryLoadBalancerInterceptor 也是 ClientHttpRequestInterceptor 的实现类</span><span class="w"></span>
<span class="w">            </span><span class="n">List</span><span class="o">&lt;</span><span class="n">ClientHttpRequestInterceptor</span><span class="o">&gt;</span><span class="w"> </span><span class="n">list</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">ArrayList</span><span class="o">&lt;&gt;</span><span class="p">(</span><span class="w"></span>
<span class="w">                    </span><span class="n">restTemplate</span><span class="p">.</span><span class="na">getInterceptors</span><span class="p">());</span><span class="w"></span>
<span class="w">            </span><span class="n">list</span><span class="p">.</span><span class="na">add</span><span class="p">(</span><span class="n">loadBalancerInterceptor</span><span class="p">);</span><span class="w"></span>
<span class="w">            </span><span class="n">restTemplate</span><span class="p">.</span><span class="na">setInterceptors</span><span class="p">(</span><span class="n">list</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="p">};</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>

<span class="p">}</span><span class="w"></span>
</code></pre></div></table></div> <p>由此可见，在程序启动的时候，如果环境中引入了相应的依赖，则会在初始化时对负载均衡器进行配置，实现的方式则是为被 @LoadBalanced 注解修饰的 RestTemplate 对象添加负载均衡拦截器。</p> <h2 id="loadbalancerclient">LoadBalancerClient 源码分析<a class="headerlink" href="#loadbalancerclient" title="Permanent link">&para;</a></h2> <p>首先我们先跟进到上文提到的拦截器(LoadBalancerInterceptor)中，可以发现，在拦截方法（intercept）中，最终是调用了 LoadBalancerClient 的 execute 方法。</p> <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 1</span>
<span class="normal"> 2</span>
<span class="normal"> 3</span>
<span class="normal"> 4</span>
<span class="normal"> 5</span>
<span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span>
<span class="normal">13</span>
<span class="normal">14</span>
<span class="normal">15</span>
<span class="normal">16</span>
<span class="normal">17</span></pre></div><td class="code"><div><pre><span></span><code><span class="kd">public</span><span class="w"> </span><span class="kd">class</span> <span class="nc">LoadBalancerInterceptor</span><span class="w"> </span><span class="kd">implements</span><span class="w"> </span><span class="n">ClientHttpRequestInterceptor</span><span class="w"> </span><span class="p">{</span><span class="w"></span>

<span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="n">LoadBalancerClient</span><span class="w"> </span><span class="n">loadBalancer</span><span class="p">;</span><span class="w"></span>

<span class="w">    </span><span class="c1">// ...</span><span class="w"></span>

<span class="w">    </span><span class="nd">@Override</span><span class="w"></span>
<span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="n">ClientHttpResponse</span><span class="w"> </span><span class="nf">intercept</span><span class="p">(</span><span class="kd">final</span><span class="w"> </span><span class="n">HttpRequest</span><span class="w"> </span><span class="n">request</span><span class="p">,</span><span class="w"> </span><span class="kd">final</span><span class="w"> </span><span class="kt">byte</span><span class="o">[]</span><span class="w"> </span><span class="n">body</span><span class="p">,</span><span class="w"></span>
<span class="w">            </span><span class="kd">final</span><span class="w"> </span><span class="n">ClientHttpRequestExecution</span><span class="w"> </span><span class="n">execution</span><span class="p">)</span><span class="w"> </span><span class="kd">throws</span><span class="w"> </span><span class="n">IOException</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="kd">final</span><span class="w"> </span><span class="n">URI</span><span class="w"> </span><span class="n">originalUri</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">request</span><span class="p">.</span><span class="na">getURI</span><span class="p">();</span><span class="w"></span>
<span class="w">        </span><span class="n">String</span><span class="w"> </span><span class="n">serviceName</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">originalUri</span><span class="p">.</span><span class="na">getHost</span><span class="p">();</span><span class="w"></span>
<span class="w">        </span><span class="n">Assert</span><span class="p">.</span><span class="na">state</span><span class="p">(</span><span class="n">serviceName</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">null</span><span class="p">,</span><span class="w"></span>
<span class="w">                </span><span class="s">&quot;Request URI does not contain a valid hostname: &quot;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">originalUri</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="na">loadBalancer</span><span class="p">.</span><span class="na">execute</span><span class="p">(</span><span class="n">serviceName</span><span class="p">,</span><span class="w"></span>
<span class="w">                </span><span class="k">this</span><span class="p">.</span><span class="na">requestFactory</span><span class="p">.</span><span class="na">createRequest</span><span class="p">(</span><span class="n">request</span><span class="p">,</span><span class="w"> </span><span class="n">body</span><span class="p">,</span><span class="w"> </span><span class="n">execution</span><span class="p">));</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div></table></div> <p><strong>LoadBalancerClient</strong> 接口中有三个方法：</p> <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1</span>
<span class="normal">2</span>
<span class="normal">3</span>
<span class="normal">4</span>
<span class="normal">5</span>
<span class="normal">6</span>
<span class="normal">7</span>
<span class="normal">8</span></pre></div><td class="code"><div><pre><span></span><code><span class="kd">public</span><span class="w"> </span><span class="kd">interface</span> <span class="nc">LoadBalancerClient</span><span class="w"> </span><span class="kd">extends</span><span class="w"> </span><span class="n">ServiceInstanceChooser</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span><span class="w"> </span><span class="n">T</span><span class="w"> </span><span class="nf">execute</span><span class="p">(</span><span class="n">String</span><span class="w"> </span><span class="n">serviceId</span><span class="p">,</span><span class="w"> </span><span class="n">LoadBalancerRequest</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span><span class="w"> </span><span class="n">request</span><span class="p">)</span><span class="w"> </span><span class="kd">throws</span><span class="w"> </span><span class="n">IOException</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="c1">// 使用 LoadBalancer 的 ServiceInstance，对其执行请求，返回结果</span><span class="w"></span>
<span class="w">    </span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span><span class="w"> </span><span class="n">T</span><span class="w"> </span><span class="nf">execute</span><span class="p">(</span><span class="n">String</span><span class="w"> </span><span class="n">serviceId</span><span class="p">,</span><span class="w"> </span><span class="n">ServiceInstance</span><span class="w"> </span><span class="n">serviceInstance</span><span class="p">,</span><span class="w"> </span><span class="n">LoadBalancerRequest</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span><span class="w"> </span><span class="n">request</span><span class="p">)</span><span class="w"> </span><span class="kd">throws</span><span class="w"> </span><span class="n">IOException</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="c1">// 构造一个包含主机和端口的真正的 url</span><span class="w"></span>
<span class="w">    </span><span class="c1">// http://serviceId/path/... --&gt; http://host:port/path/...</span><span class="w"></span>
<span class="w">    </span><span class="n">URI</span><span class="w"> </span><span class="nf">reconstructURI</span><span class="p">(</span><span class="n">ServiceInstance</span><span class="w"> </span><span class="n">instance</span><span class="p">,</span><span class="w"> </span><span class="n">URI</span><span class="w"> </span><span class="n">original</span><span class="p">);</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div></table></div> <p>其父类 ServiceInstanceChooser 中的方法：</p> <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1</span>
<span class="normal">2</span>
<span class="normal">3</span></pre></div><td class="code"><div><pre><span></span><code><span class="kd">public</span><span class="w"> </span><span class="kd">interface</span> <span class="nc">ServiceInstanceChooser</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">ServiceInstance</span><span class="w"> </span><span class="nf">choose</span><span class="p">(</span><span class="n">String</span><span class="w"> </span><span class="n">serviceId</span><span class="p">);</span><span class="w"> </span><span class="c1">// 通过 serviceId 选择服务</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div></table></div> <p>从继承关系里，LoadBalancerClient 的实现类就是 RibbonLoadBalancerClient 类了。</p> <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 1</span>
<span class="normal"> 2</span>
<span class="normal"> 3</span>
<span class="normal"> 4</span>
<span class="normal"> 5</span>
<span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span>
<span class="normal">13</span>
<span class="normal">14</span>
<span class="normal">15</span>
<span class="normal">16</span>
<span class="normal">17</span>
<span class="normal">18</span>
<span class="normal">19</span>
<span class="normal">20</span>
<span class="normal">21</span>
<span class="normal">22</span>
<span class="normal">23</span>
<span class="normal">24</span>
<span class="normal">25</span>
<span class="normal">26</span>
<span class="normal">27</span>
<span class="normal">28</span>
<span class="normal">29</span>
<span class="normal">30</span>
<span class="normal">31</span>
<span class="normal">32</span>
<span class="normal">33</span>
<span class="normal">34</span>
<span class="normal">35</span>
<span class="normal">36</span>
<span class="normal">37</span>
<span class="normal">38</span>
<span class="normal">39</span>
<span class="normal">40</span>
<span class="normal">41</span>
<span class="normal">42</span>
<span class="normal">43</span>
<span class="normal">44</span>
<span class="normal">45</span>
<span class="normal">46</span>
<span class="normal">47</span></pre></div><td class="code"><div><pre><span></span><code><span class="c1">// RibbonLoadBalancerClient.java</span><span class="w"></span>
<span class="kd">public</span><span class="w"> </span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span><span class="w"> </span><span class="n">T</span><span class="w"> </span><span class="nf">execute</span><span class="p">(</span><span class="n">String</span><span class="w"> </span><span class="n">serviceId</span><span class="p">,</span><span class="w"> </span><span class="n">LoadBalancerRequest</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span><span class="w"> </span><span class="n">request</span><span class="p">,</span><span class="w"> </span><span class="n">Object</span><span class="w"> </span><span class="n">hint</span><span class="p">)</span><span class="w"></span>
<span class="w">        </span><span class="kd">throws</span><span class="w"> </span><span class="n">IOException</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="c1">// 通过服务名获取到负载均衡器，ILoadBalancer 实现类为 DynamicServerListLoadBalancer，下文会提到</span><span class="w"></span>
<span class="w">    </span><span class="n">ILoadBalancer</span><span class="w"> </span><span class="n">loadBalancer</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">getLoadBalancer</span><span class="p">(</span><span class="n">serviceId</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="c1">// 通过调用负载均衡器的 chooseServer 方法获取到服务器</span><span class="w"></span>
<span class="w">    </span><span class="n">Server</span><span class="w"> </span><span class="n">server</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">getServer</span><span class="p">(</span><span class="n">loadBalancer</span><span class="p">,</span><span class="w"> </span><span class="n">hint</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">server</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="kc">null</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="k">throw</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">IllegalStateException</span><span class="p">(</span><span class="s">&quot;No instances available for &quot;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">serviceId</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="n">RibbonServer</span><span class="w"> </span><span class="n">ribbonServer</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">RibbonServer</span><span class="p">(</span><span class="n">serviceId</span><span class="p">,</span><span class="w"> </span><span class="n">server</span><span class="p">,</span><span class="w"></span>
<span class="w">            </span><span class="n">isSecure</span><span class="p">(</span><span class="n">server</span><span class="p">,</span><span class="w"> </span><span class="n">serviceId</span><span class="p">),</span><span class="w"></span>
<span class="w">            </span><span class="n">serverIntrospector</span><span class="p">(</span><span class="n">serviceId</span><span class="p">).</span><span class="na">getMetadata</span><span class="p">(</span><span class="n">server</span><span class="p">));</span><span class="w"></span>

<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">execute</span><span class="p">(</span><span class="n">serviceId</span><span class="p">,</span><span class="w"> </span><span class="n">ribbonServer</span><span class="p">,</span><span class="w"> </span><span class="n">request</span><span class="p">);</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
<span class="nd">@Override</span><span class="w"></span>
<span class="kd">public</span><span class="w"> </span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span><span class="w"> </span><span class="n">T</span><span class="w"> </span><span class="nf">execute</span><span class="p">(</span><span class="n">String</span><span class="w"> </span><span class="n">serviceId</span><span class="p">,</span><span class="w"> </span><span class="n">ServiceInstance</span><span class="w"> </span><span class="n">serviceInstance</span><span class="p">,</span><span class="w"></span>
<span class="w">        </span><span class="n">LoadBalancerRequest</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span><span class="w"> </span><span class="n">request</span><span class="p">)</span><span class="w"> </span><span class="kd">throws</span><span class="w"> </span><span class="n">IOException</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">Server</span><span class="w"> </span><span class="n">server</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">null</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">serviceInstance</span><span class="w"> </span><span class="k">instanceof</span><span class="w"> </span><span class="n">RibbonServer</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="n">server</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">((</span><span class="n">RibbonServer</span><span class="p">)</span><span class="w"> </span><span class="n">serviceInstance</span><span class="p">).</span><span class="na">getServer</span><span class="p">();</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">server</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="kc">null</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="k">throw</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">IllegalStateException</span><span class="p">(</span><span class="s">&quot;No instances available for &quot;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">serviceId</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>

<span class="w">    </span><span class="n">RibbonLoadBalancerContext</span><span class="w"> </span><span class="n">context</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="na">clientFactory</span><span class="w"></span>
<span class="w">            </span><span class="p">.</span><span class="na">getLoadBalancerContext</span><span class="p">(</span><span class="n">serviceId</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="n">RibbonStatsRecorder</span><span class="w"> </span><span class="n">statsRecorder</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">RibbonStatsRecorder</span><span class="p">(</span><span class="n">context</span><span class="p">,</span><span class="w"> </span><span class="n">server</span><span class="p">);</span><span class="w"></span>

<span class="w">    </span><span class="k">try</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="n">T</span><span class="w"> </span><span class="n">returnVal</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">request</span><span class="p">.</span><span class="na">apply</span><span class="p">(</span><span class="n">serviceInstance</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="n">statsRecorder</span><span class="p">.</span><span class="na">recordStats</span><span class="p">(</span><span class="n">returnVal</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">returnVal</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="c1">// catch IOException and rethrow so RestTemplate behaves correctly</span><span class="w"></span>
<span class="w">    </span><span class="k">catch</span><span class="w"> </span><span class="p">(</span><span class="n">IOException</span><span class="w"> </span><span class="n">ex</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="n">statsRecorder</span><span class="p">.</span><span class="na">recordStats</span><span class="p">(</span><span class="n">ex</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="k">throw</span><span class="w"> </span><span class="n">ex</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="k">catch</span><span class="w"> </span><span class="p">(</span><span class="n">Exception</span><span class="w"> </span><span class="n">ex</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="n">statsRecorder</span><span class="p">.</span><span class="na">recordStats</span><span class="p">(</span><span class="n">ex</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="n">ReflectionUtils</span><span class="p">.</span><span class="na">rethrowRuntimeException</span><span class="p">(</span><span class="n">ex</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="kc">null</span><span class="p">;</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div></table></div> <p>RibbonLoadBalancerClient 在 <code>execute</code> 中调用 <code>getServer</code> 方法来获取 Server 对象，跟踪源码可以看到，最终是通过 ILoadBalancer 的 <code>chooseServer</code> 去选择服务实例。</p> <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 1</span>
<span class="normal"> 2</span>
<span class="normal"> 3</span>
<span class="normal"> 4</span>
<span class="normal"> 5</span>
<span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span>
<span class="normal">13</span>
<span class="normal">14</span>
<span class="normal">15</span>
<span class="normal">16</span>
<span class="normal">17</span>
<span class="normal">18</span>
<span class="normal">19</span></pre></div><td class="code"><div><pre><span></span><code><span class="c1">// RibbonLoadBalancerClient.java</span><span class="w"></span>
<span class="kd">protected</span><span class="w"> </span><span class="n">Server</span><span class="w"> </span><span class="nf">getServer</span><span class="p">(</span><span class="n">String</span><span class="w"> </span><span class="n">serviceId</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="c1">// 通过 SpringClientFactory 获取 LoadBalancer 对象</span><span class="w"></span>
<span class="w">    </span><span class="c1">// 内部是通过反射，用构造方法构造一个实例对象</span><span class="w"></span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">getServer</span><span class="p">(</span><span class="n">getLoadBalancer</span><span class="p">(</span><span class="n">serviceId</span><span class="p">),</span><span class="w"> </span><span class="kc">null</span><span class="p">);</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="kd">protected</span><span class="w"> </span><span class="n">Server</span><span class="w"> </span><span class="nf">getServer</span><span class="p">(</span><span class="n">ILoadBalancer</span><span class="w"> </span><span class="n">loadBalancer</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">getServer</span><span class="p">(</span><span class="n">loadBalancer</span><span class="p">,</span><span class="w"> </span><span class="kc">null</span><span class="p">);</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="kd">protected</span><span class="w"> </span><span class="n">Server</span><span class="w"> </span><span class="nf">getServer</span><span class="p">(</span><span class="n">ILoadBalancer</span><span class="w"> </span><span class="n">loadBalancer</span><span class="p">,</span><span class="w"> </span><span class="n">Object</span><span class="w"> </span><span class="n">hint</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">loadBalancer</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="kc">null</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="kc">null</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="c1">// Use &#39;default&#39; on a null hint, or just pass it on?</span><span class="w"></span>
<span class="w">    </span><span class="c1">// 通过 ILoadBalancer 的 chooseServer 方法获取 Server 对象</span><span class="w"></span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">loadBalancer</span><span class="p">.</span><span class="na">chooseServer</span><span class="p">(</span><span class="n">hint</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">null</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="n">hint</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="s">&quot;default&quot;</span><span class="p">);</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div></table></div> <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 1</span>
<span class="normal"> 2</span>
<span class="normal"> 3</span>
<span class="normal"> 4</span>
<span class="normal"> 5</span>
<span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span></pre></div><td class="code"><div><pre><span></span><code><span class="kd">public</span><span class="w"> </span><span class="kd">interface</span> <span class="nc">ILoadBalancer</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="c1">// 添加一个 Server 集合</span><span class="w"></span>
<span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">addServers</span><span class="p">(</span><span class="n">List</span><span class="o">&lt;</span><span class="n">Server</span><span class="o">&gt;</span><span class="w"> </span><span class="n">newServers</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="c1">// 根据 key 获取 Server</span><span class="w"></span>
<span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="n">Server</span><span class="w"> </span><span class="nf">chooseServer</span><span class="p">(</span><span class="n">Object</span><span class="w"> </span><span class="n">key</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="c1">// 标记某个服务下线</span><span class="w"></span>
<span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">markServerDown</span><span class="p">(</span><span class="n">Server</span><span class="w"> </span><span class="n">server</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="c1">// 获取可用的 Server 集合</span><span class="w"></span>
<span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="n">List</span><span class="o">&lt;</span><span class="n">Server</span><span class="o">&gt;</span><span class="w"> </span><span class="nf">getReachableServers</span><span class="p">();</span><span class="w"></span>
<span class="w">    </span><span class="c1">// 获取所有的 Server集合</span><span class="w"></span>
<span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="n">List</span><span class="o">&lt;</span><span class="n">Server</span><span class="o">&gt;</span><span class="w"> </span><span class="nf">getAllServers</span><span class="p">();</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div></table></div> <h2 id="dynamicserverlistloadbalancer">DynamicServerListLoadBalancer<a class="headerlink" href="#dynamicserverlistloadbalancer" title="Permanent link">&para;</a></h2> <p>跟踪源码后，我们可以找到 ILoadBalancer 的继承结构如下，DynamicServerListLoadBalancer 继承了 ILoadBalancer，也就是说我们可以通过跟踪这个类来搞清楚 Ribbon 是如何实现负载均衡的。</p> <p><img alt="ILoadBalancer 继承结构" src="../images/spring-cloud-ribbon/ribbon3.png"></p> <h3 id="_3">成员介绍<a class="headerlink" href="#_3" title="Permanent link">&para;</a></h3> <p>查看 DynamicServerListLoadBalancer，BaseLoadBalancer，ILoadBalancer 这三个类，配置了 IClientConfig，IRule，IPing，ServerList，ServerListFilter 和 ILoadBalancer，在 BaseLoadBalancer 中，默认进行了以下配置：</p> <ul> <li>IClientConfig ribbonClientConfig：DefaultClientConfigImpl 配置（用于客户端的负载均衡配置）</li> <li>IRule ribbonRule：默认路由策略为 RoundRobinRule</li> <li>IPing ribbonPing：DummyPing</li> <li>ServerList ribbonServerList：ConfigurationBasedServerList</li> <li>ServerListFilter ribbonServerListFilter：ZonePreferenceServerListFilter</li> <li>ILoadBalancer ribbonLoadBalancer：ZoneAwareLoadBalancer</li> </ul> <h3 id="irule">IRule<a class="headerlink" href="#irule" title="Permanent link">&para;</a></h3> <p>IRule 有很多默认的实现类，都通过不同的算法来处理负载均衡，Ribbon 中实现的 IRule 又以下几种：</p> <p><img alt="IRule 实现类" src="../images/spring-cloud-ribbon/ribbon4.png"></p> <p><strong>IRule 实现类</strong></p> <ul> <li>BestAvailableRule：选择最小请求数</li> <li>ClientConfigEnabledRoundRobinRule：轮询</li> <li>RandomRule：随机选择 Server</li> <li>RoundRobinRule：轮询</li> <li>WeightedResponseTimeRule：根据响应时间分配一个权重 weight，weight越低，被选择的可能性就越低</li> <li>ZoneAvoidanceRule：根据 Server 的 Zone 区域和可用性轮询选择</li> </ul> <h3 id="iping">IPing<a class="headerlink" href="#iping" title="Permanent link">&para;</a></h3> <p>IPing 的实现类又 PingUrl，PingConstant，NoOpPing，DummyPing 和 NIWSDiscoveryPing。IPing 接口中有一个 <code>isAlive</code> 方法。</p> <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1</span></pre></div><td class="code"><div><pre><span></span><code><span class="kd">public</span><span class="w"> </span><span class="kt">boolean</span><span class="w"> </span><span class="nf">isAlive</span><span class="p">(</span><span class="n">Server</span><span class="w"> </span><span class="n">Server</span><span class="p">);</span><span class="w"></span>
</code></pre></div></table></div> <p>通过向 Server 发送 ping 信号，来判断 Server 是否可用</p> <p><img alt="IPing 实现类" src="../images/spring-cloud-ribbon/ribbon5.png"></p> <p><strong>IPing 实现类</strong></p> <ul> <li>PingUrl 真实的去ping 某个url，判断其是否alive</li> <li>PingConstant 固定返回某服务是否可用，默认返回true，即可用</li> <li>NoOpPing 不去ping,直接返回true,即可用。</li> <li>DummyPing 直接返回true，并实现了initWithNiwsConfig方法。</li> <li>NIWSDiscoveryPing，根据DiscoveryEnabledServer的InstanceInfo的InstanceStatus去判断，如果为InstanceStatus.UP，则为可用，否则不可用。</li> </ul> <h3 id="serverlist">ServerList<a class="headerlink" href="#serverlist" title="Permanent link">&para;</a></h3> <p>ServerList 是定义了获取所有的 Server 的注册列表信息的接口。</p> <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1</span>
<span class="normal">2</span>
<span class="normal">3</span>
<span class="normal">4</span></pre></div><td class="code"><div><pre><span></span><code><span class="kd">public</span><span class="w"> </span><span class="kd">interface</span> <span class="nc">ServerList</span><span class="o">&lt;</span><span class="n">T</span><span class="w"> </span><span class="kd">extends</span><span class="w"> </span><span class="n">Server</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="n">List</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span><span class="w"> </span><span class="nf">getInitialListOfServers</span><span class="p">();</span><span class="w"></span>
<span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="n">List</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span><span class="w"> </span><span class="nf">getUpdatedListOfServers</span><span class="p">();</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div></table></div> <p>其实现类是 <code>DiscoveryEnabledNIWSServerList</code>。</p> <h3 id="serverlistfilter">ServerListFilter<a class="headerlink" href="#serverlistfilter" title="Permanent link">&para;</a></h3> <p>ServerListFilter 可根据配置过滤或者根据特性动态获取符合条件的 Server 列表。该类也是一个接口</p> <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1</span>
<span class="normal">2</span>
<span class="normal">3</span></pre></div><td class="code"><div><pre><span></span><code><span class="kd">public</span><span class="w"> </span><span class="kd">interface</span> <span class="nc">ServerListFilter</span><span class="o">&lt;</span><span class="n">T</span><span class="w"> </span><span class="kd">extends</span><span class="w"> </span><span class="n">Server</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="n">List</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span><span class="w"> </span><span class="nf">getFilteredListOfServers</span><span class="p">(</span><span class="n">List</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span><span class="w"> </span><span class="n">servers</span><span class="p">);</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div></table></div> <h2 id="_4">源码分析<a class="headerlink" href="#_4" title="Permanent link">&para;</a></h2> <p>在 SpringClientFactory 中获取 LoadBalancer 的方法中，我们能看到获取实例的方法是通过反射获取到实现类的含有 IClientConfig 参数的构造方法来构造实例对象。</p> <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 1</span>
<span class="normal"> 2</span>
<span class="normal"> 3</span>
<span class="normal"> 4</span>
<span class="normal"> 5</span>
<span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span>
<span class="normal">13</span>
<span class="normal">14</span>
<span class="normal">15</span>
<span class="normal">16</span></pre></div><td class="code"><div><pre><span></span><code><span class="c1">// SpringClientFactory.java</span><span class="w"></span>
<span class="kd">static</span><span class="w"> </span><span class="o">&lt;</span><span class="n">C</span><span class="o">&gt;</span><span class="w"> </span><span class="n">C</span><span class="w"> </span><span class="nf">instantiateWithConfig</span><span class="p">(</span><span class="n">AnnotationConfigApplicationContext</span><span class="w"> </span><span class="n">context</span><span class="p">,</span><span class="w"></span>
<span class="w">        </span><span class="n">Class</span><span class="o">&lt;</span><span class="n">C</span><span class="o">&gt;</span><span class="w"> </span><span class="n">clazz</span><span class="p">,</span><span class="w"> </span><span class="n">IClientConfig</span><span class="w"> </span><span class="n">config</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">C</span><span class="w"> </span><span class="n">result</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">null</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="k">try</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="c1">// 获取到 ILoadBalancer 实现类的构造方法</span><span class="w"></span>
<span class="w">        </span><span class="n">Constructor</span><span class="o">&lt;</span><span class="n">C</span><span class="o">&gt;</span><span class="w"> </span><span class="n">constructor</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">clazz</span><span class="p">.</span><span class="na">getConstructor</span><span class="p">(</span><span class="n">IClientConfig</span><span class="p">.</span><span class="na">class</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="c1">// 通过构造方法构造实例对象</span><span class="w"></span>
<span class="w">        </span><span class="n">result</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">constructor</span><span class="p">.</span><span class="na">newInstance</span><span class="p">(</span><span class="n">config</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="k">catch</span><span class="w"> </span><span class="p">(</span><span class="n">Throwable</span><span class="w"> </span><span class="n">e</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="c1">// Ignored</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="c1">// ...</span><span class="w"></span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">result</span><span class="p">;</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div></table></div> <h3 id="dynamicserverlistloadbalancer_1">DynamicServerListLoadBalancer 构造方法<a class="headerlink" href="#dynamicserverlistloadbalancer_1" title="Permanent link">&para;</a></h3> <p>DynamicServerListLoadBalancer 中的构造方法中调用了一个方法 - <code>initWithNiwsConfig()</code>。</p> <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 1</span>
<span class="normal"> 2</span>
<span class="normal"> 3</span>
<span class="normal"> 4</span>
<span class="normal"> 5</span>
<span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span>
<span class="normal">13</span>
<span class="normal">14</span>
<span class="normal">15</span>
<span class="normal">16</span>
<span class="normal">17</span>
<span class="normal">18</span>
<span class="normal">19</span>
<span class="normal">20</span>
<span class="normal">21</span>
<span class="normal">22</span>
<span class="normal">23</span>
<span class="normal">24</span>
<span class="normal">25</span>
<span class="normal">26</span>
<span class="normal">27</span>
<span class="normal">28</span>
<span class="normal">29</span>
<span class="normal">30</span></pre></div><td class="code"><div><pre><span></span><code><span class="c1">// DynamicServerListLoadBalancer.java</span><span class="w"></span>
<span class="kd">public</span><span class="w"> </span><span class="nf">DynamicServerListLoadBalancer</span><span class="p">(</span><span class="n">IClientConfig</span><span class="w"> </span><span class="n">clientConfig</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">initWithNiwsConfig</span><span class="p">(</span><span class="n">clientConfig</span><span class="p">);</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
<span class="kd">public</span><span class="w"> </span><span class="nf">initWithNiwsConfig</span><span class="p">(</span><span class="n">IClientConfig</span><span class="w"> </span><span class="n">clientConfig</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">try</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="kd">super</span><span class="p">.</span><span class="na">initWithNiwsConfig</span><span class="p">(</span><span class="n">clientConfig</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="c1">// 获取 ServerList 的 classname</span><span class="w"></span>
<span class="w">        </span><span class="n">String</span><span class="w"> </span><span class="n">niwsServerListClassname</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">clientConfig</span><span class="p">.</span><span class="na">getPropertyAsString</span><span class="p">(</span><span class="n">CommonClientConfigKey</span><span class="p">.</span><span class="na">NIWSServerListClassName</span><span class="p">,</span><span class="w"> </span><span class="n">DefaultClientConfigImpl</span><span class="p">.</span><span class="na">DEFAULT_SERVER_LIST_CLASS</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="c1">// 构造 ServerList</span><span class="w"></span>
<span class="w">        </span><span class="n">ServerList</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span><span class="w"> </span><span class="n">niwsServerListImpl</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">ServerList</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span><span class="p">)</span><span class="w"> </span><span class="n">ClientFactory</span><span class="p">.</span><span class="na">instantiateInstanceWithClientConfig</span><span class="p">(</span><span class="n">niwsServerListClassName</span><span class="p">,</span><span class="w"> </span><span class="n">clientConfig</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="c1">// 如果该 ServerList 是 AbstractServerList 的子类，则获取并设置过滤器</span><span class="w"></span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">niwsServerListImpl</span><span class="w"> </span><span class="k">instanceof</span><span class="w"> </span><span class="n">AbstractServerList</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">            </span><span class="n">AbstractServerListFilter</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span><span class="w"> </span><span class="n">niwsFilter</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">((</span><span class="n">AbstractServerList</span><span class="p">)</span><span class="w"> </span><span class="n">niwsServerListImpl</span><span class="p">).</span><span class="na">getFilterImpl</span><span class="p">(</span><span class="n">clientConfig</span><span class="p">);</span><span class="w"></span>
<span class="w">            </span><span class="n">niwsFilter</span><span class="p">.</span><span class="na">setLoadBalancerStats</span><span class="p">(</span><span class="n">getLoadBalancerStats</span><span class="p">());</span><span class="w"></span>
<span class="w">            </span><span class="k">this</span><span class="p">.</span><span class="na">filter</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">niwsFilter</span><span class="p">;</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="w"></span>
<span class="w">        </span><span class="c1">// 获取 ServerListUpdater 的 classname</span><span class="w"></span>
<span class="w">        </span><span class="n">String</span><span class="w"> </span><span class="n">serverListUpdaterClassName</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">clientConfig</span><span class="p">.</span><span class="na">getPropertyAsString</span><span class="p">(</span><span class="w"></span>
<span class="w">            </span><span class="n">CommonClientConfigKey</span><span class="p">.</span><span class="na">ServerListUpdaterClassname</span><span class="p">,</span><span class="w"></span>
<span class="w">            </span><span class="n">DefaultClientConfigImpl</span><span class="p">.</span><span class="na">DEFAULT_SERVER_LIST_UPDATER_CLASS</span><span class="w"></span>
<span class="w">        </span><span class="p">);</span><span class="w"></span>

<span class="w">        </span><span class="c1">// 通过 classname 构造 ServerListUpdater 设置到 serverListUpdater 成员属性中</span><span class="w"></span>
<span class="w">        </span><span class="k">this</span><span class="p">.</span><span class="na">serverListUpdater</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">ServerListUpdater</span><span class="p">)</span><span class="w"> </span><span class="n">ClientFactory</span><span class="w"></span>
<span class="w">            </span><span class="p">.</span><span class="na">instantiateInstanceWithClientConfig</span><span class="p">(</span><span class="n">serverListUpdaterClassName</span><span class="p">,</span><span class="w"> </span><span class="n">clientConfig</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="c1">// 执行剩下的初始化操作</span><span class="w"></span>
<span class="w">        </span><span class="n">restOfInit</span><span class="p">(</span><span class="n">clientConfig</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div></table></div> <h3 id="restofinit">restOfInit 执行剩下的初始化操作<a class="headerlink" href="#restofinit" title="Permanent link">&para;</a></h3> <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 1</span>
<span class="normal"> 2</span>
<span class="normal"> 3</span>
<span class="normal"> 4</span>
<span class="normal"> 5</span>
<span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span>
<span class="normal">13</span>
<span class="normal">14</span></pre></div><td class="code"><div><pre><span></span><code><span class="c1">// DynamicServerListLoadBalancer.java</span><span class="w"></span>
<span class="kt">void</span><span class="w"> </span><span class="nf">restOfInit</span><span class="p">(</span><span class="n">IClientConfig</span><span class="w"> </span><span class="n">clientConfig</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="kt">boolean</span><span class="w"> </span><span class="n">primeConnection</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="na">isEnablePrimingConnections</span><span class="p">();</span><span class="w"></span>
<span class="w">    </span><span class="c1">// 将这个关闭来避免 BaseLoadBalancer.setServerList() 中重复的异步启动</span><span class="w"></span>
<span class="w">    </span><span class="k">this</span><span class="p">.</span><span class="na">setEnablePrimingConnections</span><span class="p">(</span><span class="kc">false</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="n">enableAndInitLearnNewServersFeature</span><span class="p">();</span><span class="w"></span>

<span class="w">    </span><span class="n">updateListOfServers</span><span class="p">();</span><span class="w"> </span><span class="c1">// 用来获取所有的 Server </span><span class="w"></span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">primeConnection</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="na">getPrimeConnections</span><span class="p">()</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">null</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="k">this</span><span class="p">.</span><span class="na">getPrimeConnections</span><span class="p">().</span><span class="na">primeConnections</span><span class="p">(</span><span class="n">getReachableServers</span><span class="p">());</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="k">this</span><span class="p">.</span><span class="na">setEnablePrimingConnections</span><span class="p">(</span><span class="n">primeConnection</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="n">LOGGER</span><span class="p">.</span><span class="na">info</span><span class="p">(</span><span class="s">&quot;DynamicServerListLoadBalancer for client {} initialized: {}&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">clientConfig</span><span class="p">.</span><span class="na">getClientName</span><span class="p">(),</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="na">toString</span><span class="p">());</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div></table></div> <p>上面源码中的 <code>updateListOfServers()</code> 最终是通过 serverListImpl.getUpdatedListOfServers() 来获取所有的服务列表的：</p> <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 1</span>
<span class="normal"> 2</span>
<span class="normal"> 3</span>
<span class="normal"> 4</span>
<span class="normal"> 5</span>
<span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span>
<span class="normal">13</span>
<span class="normal">14</span>
<span class="normal">15</span>
<span class="normal">16</span></pre></div><td class="code"><div><pre><span></span><code><span class="c1">// DynamicServerListLoadBalancer.java</span><span class="w"></span>
<span class="nd">@VisibleForTesting</span><span class="w"></span>
<span class="kd">public</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">updateListOfServers</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">List</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span><span class="w"> </span><span class="n">servers</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">ArrayList</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span><span class="p">();</span><span class="w"></span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">serverListImpl</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">null</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="n">servers</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">serverListImpl</span><span class="p">.</span><span class="na">getUpdatedListOfServers</span><span class="p">();</span><span class="w"></span>
<span class="w">        </span><span class="n">LOGGER</span><span class="p">.</span><span class="na">debug</span><span class="p">(</span><span class="s">&quot;List of Servers for {} obtained from Discovery client: {}&quot;</span><span class="p">,</span><span class="w"> </span>
<span class="w">                     </span><span class="n">getIdentifier</span><span class="p">(),</span><span class="w"> </span><span class="n">servers</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">filter</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">null</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">            </span><span class="c1">// 如果配置了过滤器，则将符合条件的 server 筛选出来</span><span class="w"></span>
<span class="w">            </span><span class="n">servers</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">filter</span><span class="p">.</span><span class="na">getFilteredListOfServers</span><span class="p">(</span><span class="n">servers</span><span class="p">);</span><span class="w"></span>
<span class="w">            </span><span class="n">LOGGER</span><span class="p">.</span><span class="na">debug</span><span class="p">(</span><span class="s">&quot;Filtered List of Servers for {} obtained from Discovery client: {}&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">getIdentifier</span><span class="p">(),</span><span class="w"> </span><span class="n">servers</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="n">updateAllServerList</span><span class="p">(</span><span class="n">servers</span><span class="p">);</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div></table></div> <p>其中 serverListImpl 是 ServerList 的实现类 - DiscoveryEnabledNIWSServerList。而 <code>getUpdatedListOfServers()</code> 的具体实现为：</p> <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1</span>
<span class="normal">2</span>
<span class="normal">3</span>
<span class="normal">4</span>
<span class="normal">5</span>
<span class="normal">6</span>
<span class="normal">7</span>
<span class="normal">8</span></pre></div><td class="code"><div><pre><span></span><code><span class="c1">// DiscoveryEnabledNIWSServerList.java</span><span class="w"></span>
<span class="nd">@Override</span><span class="w"></span>
<span class="kd">public</span><span class="w"> </span><span class="n">List</span><span class="o">&lt;</span><span class="n">DiscoveryEnabledServer</span><span class="o">&gt;</span><span class="w"> </span><span class="nf">getInitialListOfServers</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">obtainServersViaDiscovery</span><span class="p">();</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
<span class="kd">public</span><span class="w"> </span><span class="n">List</span><span class="o">&lt;</span><span class="n">DiscoveryEnabledServer</span><span class="o">&gt;</span><span class="w"> </span><span class="nf">getUpdatedListOfServers</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">obtainServersViaDiscovery</span><span class="p">();</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div></table></div> <h3 id="obtainserversviadiscovery">obtainServersViaDiscovery<a class="headerlink" href="#obtainserversviadiscovery" title="Permanent link">&para;</a></h3> <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 1</span>
<span class="normal"> 2</span>
<span class="normal"> 3</span>
<span class="normal"> 4</span>
<span class="normal"> 5</span>
<span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span>
<span class="normal">13</span>
<span class="normal">14</span>
<span class="normal">15</span>
<span class="normal">16</span>
<span class="normal">17</span>
<span class="normal">18</span>
<span class="normal">19</span>
<span class="normal">20</span>
<span class="normal">21</span>
<span class="normal">22</span>
<span class="normal">23</span>
<span class="normal">24</span>
<span class="normal">25</span>
<span class="normal">26</span>
<span class="normal">27</span>
<span class="normal">28</span>
<span class="normal">29</span>
<span class="normal">30</span>
<span class="normal">31</span>
<span class="normal">32</span>
<span class="normal">33</span>
<span class="normal">34</span>
<span class="normal">35</span>
<span class="normal">36</span>
<span class="normal">37</span>
<span class="normal">38</span>
<span class="normal">39</span>
<span class="normal">40</span>
<span class="normal">41</span>
<span class="normal">42</span>
<span class="normal">43</span>
<span class="normal">44</span>
<span class="normal">45</span>
<span class="normal">46</span></pre></div><td class="code"><div><pre><span></span><code><span class="c1">// DiscoveryEnabledNIWSServerList.java</span><span class="w"></span>
<span class="kd">private</span><span class="w"> </span><span class="n">List</span><span class="o">&lt;</span><span class="n">DiscoveryEnabledServer</span><span class="o">&gt;</span><span class="w"> </span><span class="nf">obtainServersViaDiscovery</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">List</span><span class="o">&lt;</span><span class="n">DiscoveryEnabledServer</span><span class="o">&gt;</span><span class="w"> </span><span class="n">serverList</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">ArrayList</span><span class="o">&lt;</span><span class="n">DiscoveryEnabledServer</span><span class="o">&gt;</span><span class="p">();</span><span class="w"></span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">eurekaClientProvider</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="kc">null</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="n">eurekaClientProvider</span><span class="p">.</span><span class="na">get</span><span class="p">()</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="kc">null</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="n">logger</span><span class="p">.</span><span class="na">warn</span><span class="p">(</span><span class="s">&quot;EurekaClient has not been initialized yet, returning an empty list&quot;</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">ArrayList</span><span class="o">&lt;</span><span class="n">DiscoveryEnabledServer</span><span class="o">&gt;</span><span class="p">();</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>

<span class="w">    </span><span class="n">EurekaClient</span><span class="w"> </span><span class="n">eurekaClient</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">eurekaClientProvider</span><span class="p">.</span><span class="na">get</span><span class="p">();</span><span class="w"></span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">vipAddresses</span><span class="o">!=</span><span class="kc">null</span><span class="p">){</span><span class="w"></span>
<span class="w">        </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">String</span><span class="w"> </span><span class="n">vipAddress</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="n">vipAddresses</span><span class="p">.</span><span class="na">split</span><span class="p">(</span><span class="s">&quot;,&quot;</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">            </span><span class="c1">// if targetRegion is null, it will be interpreted as the same region of client</span><span class="w"></span>
<span class="w">            </span><span class="n">List</span><span class="o">&lt;</span><span class="n">InstanceInfo</span><span class="o">&gt;</span><span class="w"> </span><span class="n">listOfInstanceInfo</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">eurekaClient</span><span class="p">.</span><span class="na">getInstancesByVipAddress</span><span class="p">(</span><span class="n">vipAddress</span><span class="p">,</span><span class="w"> </span><span class="n">isSecure</span><span class="p">,</span><span class="w"> </span><span class="n">targetRegion</span><span class="p">);</span><span class="w"></span>
<span class="w">            </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">InstanceInfo</span><span class="w"> </span><span class="n">ii</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="n">listOfInstanceInfo</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">                </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">ii</span><span class="p">.</span><span class="na">getStatus</span><span class="p">().</span><span class="na">equals</span><span class="p">(</span><span class="n">InstanceStatus</span><span class="p">.</span><span class="na">UP</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w"></span>

<span class="w">                    </span><span class="k">if</span><span class="p">(</span><span class="n">shouldUseOverridePort</span><span class="p">){</span><span class="w"></span>
<span class="w">                        </span><span class="k">if</span><span class="p">(</span><span class="n">logger</span><span class="p">.</span><span class="na">isDebugEnabled</span><span class="p">()){</span><span class="w"></span>
<span class="w">                            </span><span class="n">logger</span><span class="p">.</span><span class="na">debug</span><span class="p">(</span><span class="s">&quot;Overriding port on client name: &quot;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">clientName</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s">&quot; to &quot;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">overridePort</span><span class="p">);</span><span class="w"></span>
<span class="w">                        </span><span class="p">}</span><span class="w"></span>

<span class="w">                        </span><span class="c1">// copy is necessary since the InstanceInfo builder just uses the original reference,</span><span class="w"></span>
<span class="w">                        </span><span class="c1">// and we don&#39;t want to corrupt the global eureka copy of the object which may be</span><span class="w"></span>
<span class="w">                        </span><span class="c1">// used by other clients in our system</span><span class="w"></span>
<span class="w">                        </span><span class="n">InstanceInfo</span><span class="w"> </span><span class="n">copy</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">InstanceInfo</span><span class="p">(</span><span class="n">ii</span><span class="p">);</span><span class="w"></span>

<span class="w">                        </span><span class="k">if</span><span class="p">(</span><span class="n">isSecure</span><span class="p">){</span><span class="w"></span>
<span class="w">                            </span><span class="n">ii</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">InstanceInfo</span><span class="p">.</span><span class="na">Builder</span><span class="p">(</span><span class="n">copy</span><span class="p">).</span><span class="na">setSecurePort</span><span class="p">(</span><span class="n">overridePort</span><span class="p">).</span><span class="na">build</span><span class="p">();</span><span class="w"></span>
<span class="w">                        </span><span class="p">}</span><span class="k">else</span><span class="p">{</span><span class="w"></span>
<span class="w">                            </span><span class="n">ii</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">InstanceInfo</span><span class="p">.</span><span class="na">Builder</span><span class="p">(</span><span class="n">copy</span><span class="p">).</span><span class="na">setPort</span><span class="p">(</span><span class="n">overridePort</span><span class="p">).</span><span class="na">build</span><span class="p">();</span><span class="w"></span>
<span class="w">                        </span><span class="p">}</span><span class="w"></span>
<span class="w">                    </span><span class="p">}</span><span class="w"></span>

<span class="w">                    </span><span class="n">DiscoveryEnabledServer</span><span class="w"> </span><span class="n">des</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">DiscoveryEnabledServer</span><span class="p">(</span><span class="n">ii</span><span class="p">,</span><span class="w"> </span><span class="n">isSecure</span><span class="p">,</span><span class="w"> </span><span class="n">shouldUseIpAddr</span><span class="p">);</span><span class="w"></span>
<span class="w">                    </span><span class="n">des</span><span class="p">.</span><span class="na">setZone</span><span class="p">(</span><span class="n">DiscoveryClient</span><span class="p">.</span><span class="na">getZone</span><span class="p">(</span><span class="n">ii</span><span class="p">));</span><span class="w"></span>
<span class="w">                    </span><span class="n">serverList</span><span class="p">.</span><span class="na">add</span><span class="p">(</span><span class="n">des</span><span class="p">);</span><span class="w"></span>
<span class="w">                </span><span class="p">}</span><span class="w"></span>
<span class="w">            </span><span class="p">}</span><span class="w"></span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">serverList</span><span class="p">.</span><span class="na">size</span><span class="p">()</span><span class="o">&gt;</span><span class="mi">0</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">prioritizeVipAddressBasedServers</span><span class="p">){</span><span class="w"></span>
<span class="w">                </span><span class="k">break</span><span class="p">;</span><span class="w"> </span><span class="c1">// if the current vipAddress has servers, we dont use subsequent vipAddress based servers</span><span class="w"></span>
<span class="w">            </span><span class="p">}</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">serverList</span><span class="p">;</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div></table></div> <p>看到这里，可以知道负载均衡器 Ribbon 是通过 Eureka Client 来获取注册列表信息，然后通过配置的路由规则 IRule 来路由。但是它从 Eureka Client 获取注册信息的时间间隔是多久呢？</p> <h3 id="_5">定时任务更新服务器列表和状态<a class="headerlink" href="#_5" title="Permanent link">&para;</a></h3> <p>在构造 DynamicServerListLoadBalancer 的构造方法中的第一行是调用父类中的 <code>initWithNiwsConfig</code> 方法。</p> <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1</span>
<span class="normal">2</span>
<span class="normal">3</span>
<span class="normal">4</span>
<span class="normal">5</span>
<span class="normal">6</span>
<span class="normal">7</span></pre></div><td class="code"><div><pre><span></span><code><span class="c1">// DynamicServerListLoadBalancer.java</span><span class="w"></span>
<span class="kd">public</span><span class="w"> </span><span class="nf">initWithNiwsConfig</span><span class="p">(</span><span class="n">IClientConfig</span><span class="w"> </span><span class="n">clientConfig</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">try</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="kd">super</span><span class="p">.</span><span class="na">initWithNiwsConfig</span><span class="p">(</span><span class="n">clientConfig</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="c1">// ...</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div></table></div> <p>于是我们跟踪到 BaseLoadBalancer 的 initWithNiwsConfig 方法中：</p> <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 1</span>
<span class="normal"> 2</span>
<span class="normal"> 3</span>
<span class="normal"> 4</span>
<span class="normal"> 5</span>
<span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span>
<span class="normal">13</span>
<span class="normal">14</span>
<span class="normal">15</span>
<span class="normal">16</span>
<span class="normal">17</span>
<span class="normal">18</span>
<span class="normal">19</span>
<span class="normal">20</span>
<span class="normal">21</span>
<span class="normal">22</span>
<span class="normal">23</span>
<span class="normal">24</span>
<span class="normal">25</span>
<span class="normal">26</span>
<span class="normal">27</span>
<span class="normal">28</span>
<span class="normal">29</span>
<span class="normal">30</span>
<span class="normal">31</span>
<span class="normal">32</span>
<span class="normal">33</span>
<span class="normal">34</span>
<span class="normal">35</span></pre></div><td class="code"><div><pre><span></span><code><span class="c1">// BaseLoadBalancer.java</span><span class="w"></span>
<span class="nd">@Override</span><span class="w"></span>
<span class="kd">public</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">initWithNiwsConfig</span><span class="p">(</span><span class="n">IClientConfig</span><span class="w"> </span><span class="n">clientConfig</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">try</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="n">initWithNiwsConfig</span><span class="p">(</span><span class="n">clientConfig</span><span class="p">,</span><span class="w"> </span><span class="n">ClientFactory</span><span class="p">::</span><span class="n">instantiateInstanceWithClientConfig</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="p">(</span><span class="n">Exception</span><span class="w"> </span><span class="n">e</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="k">throw</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">RuntimeException</span><span class="p">(</span><span class="s">&quot;Error initializing load balancer&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">e</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
<span class="nd">@Override</span><span class="w"></span>
<span class="kd">public</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">initWithNiwsConfig</span><span class="p">(</span><span class="n">IClientConfig</span><span class="w"> </span><span class="n">clientConfig</span><span class="p">,</span><span class="w"> </span><span class="n">Factory</span><span class="w"> </span><span class="n">factory</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">S</span><span class="c1">// ...</span><span class="w"></span>
<span class="w">    </span><span class="k">try</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="c1">// ...</span><span class="w"></span>
<span class="w">        </span><span class="n">initWithConfig</span><span class="p">(</span><span class="n">clientConfig</span><span class="p">,</span><span class="w"> </span><span class="n">rule</span><span class="p">,</span><span class="w"> </span><span class="n">ping</span><span class="p">,</span><span class="w"> </span><span class="n">stats</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="p">(</span><span class="n">Exception</span><span class="w"> </span><span class="n">e</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="k">throw</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">RuntimeException</span><span class="p">(</span><span class="s">&quot;Error initializing load balancer&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">e</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="kt">void</span><span class="w"> </span><span class="nf">initWithConfig</span><span class="p">(</span><span class="n">IClientConfig</span><span class="w"> </span><span class="n">clientConfig</span><span class="p">,</span><span class="w"> </span><span class="n">IRule</span><span class="w"> </span><span class="n">rule</span><span class="p">,</span><span class="w"> </span><span class="n">IPing</span><span class="w"> </span><span class="n">ping</span><span class="p">,</span><span class="w"> </span><span class="n">LoadBalancerStats</span><span class="w"> </span><span class="n">stats</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="c1">// ...</span><span class="w"></span>

<span class="w">    </span><span class="n">setPingInterval</span><span class="p">(</span><span class="n">pingIntervalTime</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="n">setMaxTotalPingTime</span><span class="p">(</span><span class="n">maxTotalPingTime</span><span class="p">);</span><span class="w"></span>

<span class="w">    </span><span class="c1">// cross associate with each other</span><span class="w"></span>
<span class="w">    </span><span class="c1">// i.e. Rule,Ping meet your container LB</span><span class="w"></span>
<span class="w">    </span><span class="c1">// LB, these are your Ping and Rule guys ...</span><span class="w"></span>
<span class="w">    </span><span class="n">setRule</span><span class="p">(</span><span class="n">rule</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="n">setPing</span><span class="p">(</span><span class="n">ping</span><span class="p">);</span><span class="w"></span>

<span class="w">    </span><span class="c1">// ...</span><span class="w"></span>

<span class="p">}</span><span class="w"></span>
</code></pre></div></table></div> <p>以上只保留了关键代码。调用到 initWithConfig 方法中，会执行 <code>setPingInterval(pingIntervalTime)</code> 方法。</p> <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 1</span>
<span class="normal"> 2</span>
<span class="normal"> 3</span>
<span class="normal"> 4</span>
<span class="normal"> 5</span>
<span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span></pre></div><td class="code"><div><pre><span></span><code><span class="kd">public</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">setPingInterval</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">pingIntervalSeconds</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">pingIntervalSeconds</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="k">return</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>

<span class="w">    </span><span class="k">this</span><span class="p">.</span><span class="na">pingIntervalSeconds</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">pingIntervalSeconds</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">logger</span><span class="p">.</span><span class="na">isDebugEnabled</span><span class="p">())</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="n">logger</span><span class="p">.</span><span class="na">debug</span><span class="p">(</span><span class="s">&quot;LoadBalancer [{}]:  pingIntervalSeconds set to {}&quot;</span><span class="p">,</span><span class="w"></span>
<span class="w">            </span><span class="n">name</span><span class="p">,</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="na">pingIntervalSeconds</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="n">setupPingTask</span><span class="p">();</span><span class="w"> </span><span class="c1">// since ping data changed</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div></table></div> <p>其中开启了一个定时任务：<code>setupPingTask()</code> 。在该方法内部使用 ShutdownEnabledTimer 初始化了一个定时器，并且设置每10秒调用 PingTask 任务。</p> <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 1</span>
<span class="normal"> 2</span>
<span class="normal"> 3</span>
<span class="normal"> 4</span>
<span class="normal"> 5</span>
<span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span>
<span class="normal">13</span>
<span class="normal">14</span></pre></div><td class="code"><div><pre><span></span><code><span class="c1">// BaseLoadBalancer.java</span><span class="w"></span>
<span class="c1">// 定时任务</span><span class="w"></span>
<span class="kt">void</span><span class="w"> </span><span class="nf">setupPingTask</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">canSkipPing</span><span class="p">())</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="k">return</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">lbTimer</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">null</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="n">lbTimer</span><span class="p">.</span><span class="na">cancel</span><span class="p">();</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="n">lbTimer</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">ShutdownEnabledTimer</span><span class="p">(</span><span class="s">&quot;NFLoadBalancer-PingTimer-&quot;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">name</span><span class="p">,</span><span class="w"></span>
<span class="w">            </span><span class="kc">true</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="n">lbTimer</span><span class="p">.</span><span class="na">schedule</span><span class="p">(</span><span class="k">new</span><span class="w"> </span><span class="n">PingTask</span><span class="p">(),</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">pingIntervalSeconds</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mi">1000</span><span class="p">);</span><span class="w"> </span><span class="c1">// 默认10秒执行一次</span><span class="w"></span>
<span class="w">    </span><span class="n">forceQuickPing</span><span class="p">();</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div></table></div> <p>PingTask 是 BaseLoadBalancer 的内部类，根据 IPingStrategy 策略来发送 ping 请求获取和更新服务器列表，默认策略是 SerialPingStrategy。在 PingTask 的 run 方法中，执行了另一个内部类 Pinger 的 runPinger 方法。</p> <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 1</span>
<span class="normal"> 2</span>
<span class="normal"> 3</span>
<span class="normal"> 4</span>
<span class="normal"> 5</span>
<span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span>
<span class="normal">13</span>
<span class="normal">14</span>
<span class="normal">15</span>
<span class="normal">16</span>
<span class="normal">17</span>
<span class="normal">18</span>
<span class="normal">19</span>
<span class="normal">20</span>
<span class="normal">21</span>
<span class="normal">22</span>
<span class="normal">23</span>
<span class="normal">24</span>
<span class="normal">25</span>
<span class="normal">26</span>
<span class="normal">27</span>
<span class="normal">28</span>
<span class="normal">29</span>
<span class="normal">30</span>
<span class="normal">31</span>
<span class="normal">32</span>
<span class="normal">33</span>
<span class="normal">34</span>
<span class="normal">35</span>
<span class="normal">36</span>
<span class="normal">37</span>
<span class="normal">38</span>
<span class="normal">39</span>
<span class="normal">40</span>
<span class="normal">41</span>
<span class="normal">42</span>
<span class="normal">43</span>
<span class="normal">44</span>
<span class="normal">45</span>
<span class="normal">46</span>
<span class="normal">47</span>
<span class="normal">48</span>
<span class="normal">49</span>
<span class="normal">50</span>
<span class="normal">51</span>
<span class="normal">52</span>
<span class="normal">53</span>
<span class="normal">54</span>
<span class="normal">55</span>
<span class="normal">56</span>
<span class="normal">57</span>
<span class="normal">58</span>
<span class="normal">59</span>
<span class="normal">60</span>
<span class="normal">61</span>
<span class="normal">62</span>
<span class="normal">63</span>
<span class="normal">64</span>
<span class="normal">65</span>
<span class="normal">66</span>
<span class="normal">67</span>
<span class="normal">68</span>
<span class="normal">69</span>
<span class="normal">70</span>
<span class="normal">71</span>
<span class="normal">72</span>
<span class="normal">73</span>
<span class="normal">74</span>
<span class="normal">75</span>
<span class="normal">76</span>
<span class="normal">77</span>
<span class="normal">78</span>
<span class="normal">79</span>
<span class="normal">80</span>
<span class="normal">81</span>
<span class="normal">82</span>
<span class="normal">83</span>
<span class="normal">84</span>
<span class="normal">85</span>
<span class="normal">86</span>
<span class="normal">87</span>
<span class="normal">88</span>
<span class="normal">89</span>
<span class="normal">90</span>
<span class="normal">91</span>
<span class="normal">92</span>
<span class="normal">93</span></pre></div><td class="code"><div><pre><span></span><code><span class="c1">// BaseLoadBalancer.java</span><span class="w"></span>
<span class="c1">// 内部类 PingTask</span><span class="w"></span>
<span class="kd">class</span> <span class="nc">PingTask</span><span class="w"> </span><span class="kd">extends</span><span class="w"> </span><span class="n">TimerTask</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">run</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="k">try</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">            </span><span class="k">new</span><span class="w"> </span><span class="n">Pinger</span><span class="p">(</span><span class="n">pingStrategy</span><span class="p">).</span><span class="na">runPinger</span><span class="p">();</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="p">(</span><span class="n">Exception</span><span class="w"> </span><span class="n">e</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">            </span><span class="n">logger</span><span class="p">.</span><span class="na">error</span><span class="p">(</span><span class="s">&quot;LoadBalancer [{}]: Error pinging&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">name</span><span class="p">,</span><span class="w"> </span><span class="n">e</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
<span class="c1">// 内部类 Pinger</span><span class="w"></span>
<span class="kd">class</span> <span class="nc">Pinger</span><span class="w"> </span><span class="p">{</span><span class="w"></span>

<span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="kd">final</span><span class="w"> </span><span class="n">IPingStrategy</span><span class="w"> </span><span class="n">pingerStrategy</span><span class="p">;</span><span class="w"></span>

<span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="nf">Pinger</span><span class="p">(</span><span class="n">IPingStrategy</span><span class="w"> </span><span class="n">pingerStrategy</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="k">this</span><span class="p">.</span><span class="na">pingerStrategy</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">pingerStrategy</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>

<span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">runPinger</span><span class="p">()</span><span class="w"> </span><span class="kd">throws</span><span class="w"> </span><span class="n">Exception</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="c1">// 用 CAS 设置 pingInProgress 为 true，代表正在执行 Ping 任务。</span><span class="w"></span>
<span class="w">        </span><span class="c1">// 如果设置失败，则表示有线程正在执行 Ping 任务，这里就不再执行</span><span class="w"></span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">pingInProgress</span><span class="p">.</span><span class="na">compareAndSet</span><span class="p">(</span><span class="kc">false</span><span class="p">,</span><span class="w"> </span><span class="kc">true</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w"> </span>
<span class="w">            </span><span class="k">return</span><span class="p">;</span><span class="w"> </span><span class="c1">// Ping in progress - nothing to do</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="w"></span>

<span class="w">        </span><span class="c1">// we are &quot;in&quot; - we get to Ping</span><span class="w"></span>

<span class="w">        </span><span class="n">Server</span><span class="o">[]</span><span class="w"> </span><span class="n">allServers</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">null</span><span class="p">;</span><span class="w"></span>
<span class="w">        </span><span class="kt">boolean</span><span class="o">[]</span><span class="w"> </span><span class="n">results</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">null</span><span class="p">;</span><span class="w"></span>

<span class="w">        </span><span class="n">Lock</span><span class="w"> </span><span class="n">allLock</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">null</span><span class="p">;</span><span class="w"></span>
<span class="w">        </span><span class="n">Lock</span><span class="w"> </span><span class="n">upLock</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">null</span><span class="p">;</span><span class="w"></span>

<span class="w">        </span><span class="k">try</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">            </span><span class="cm">/*</span>
<span class="cm">             * The readLock should be free unless an addServer operation is</span>
<span class="cm">             * going on...</span>
<span class="cm">             */</span><span class="w"></span>
<span class="w">            </span><span class="c1">// 读锁应该是空闲状态，除了 addServer 操作正在执行。</span><span class="w"></span>
<span class="w">            </span><span class="n">allLock</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">allServerLock</span><span class="p">.</span><span class="na">readLock</span><span class="p">();</span><span class="w"></span>
<span class="w">            </span><span class="c1">// 加读锁，避免其他线程修改 serverList</span><span class="w"></span>
<span class="w">            </span><span class="n">allLock</span><span class="p">.</span><span class="na">lock</span><span class="p">();</span><span class="w"></span>
<span class="w">            </span><span class="n">allServers</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">allServerList</span><span class="p">.</span><span class="na">toArray</span><span class="p">(</span><span class="k">new</span><span class="w"> </span><span class="n">Server</span><span class="o">[</span><span class="n">allServerList</span><span class="p">.</span><span class="na">size</span><span class="p">()</span><span class="o">]</span><span class="p">);</span><span class="w"></span>
<span class="w">            </span><span class="c1">// 解锁</span><span class="w"></span>
<span class="w">            </span><span class="n">allLock</span><span class="p">.</span><span class="na">unlock</span><span class="p">();</span><span class="w"></span>

<span class="w">            </span><span class="kt">int</span><span class="w"> </span><span class="n">numCandidates</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">allServers</span><span class="p">.</span><span class="na">length</span><span class="p">;</span><span class="w"></span>
<span class="w">            </span><span class="c1">// 向每个服务器发送 ping 请求，得到一个布尔值的结果集（服务器是否存活 - 能否请求成功）</span><span class="w"></span>
<span class="w">            </span><span class="n">results</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">pingerStrategy</span><span class="p">.</span><span class="na">pingServers</span><span class="p">(</span><span class="n">ping</span><span class="p">,</span><span class="w"> </span><span class="n">allServers</span><span class="p">);</span><span class="w"></span>

<span class="w">            </span><span class="kd">final</span><span class="w"> </span><span class="n">List</span><span class="o">&lt;</span><span class="n">Server</span><span class="o">&gt;</span><span class="w"> </span><span class="n">newUpList</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">ArrayList</span><span class="o">&lt;</span><span class="n">Server</span><span class="o">&gt;</span><span class="p">();</span><span class="w"></span>
<span class="w">            </span><span class="kd">final</span><span class="w"> </span><span class="n">List</span><span class="o">&lt;</span><span class="n">Server</span><span class="o">&gt;</span><span class="w"> </span><span class="n">changedServers</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">ArrayList</span><span class="o">&lt;</span><span class="n">Server</span><span class="o">&gt;</span><span class="p">();</span><span class="w"></span>

<span class="w">            </span><span class="c1">// 遍历当前所有Server</span><span class="w"></span>
<span class="w">            </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">numCandidates</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">                </span><span class="c1">// 获取第 i 个 Server 是当前否为存活状态（UP）</span><span class="w"></span>
<span class="w">                </span><span class="kt">boolean</span><span class="w"> </span><span class="n">isAlive</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">results</span><span class="o">[</span><span class="n">i</span><span class="o">]</span><span class="p">;</span><span class="w"></span>
<span class="w">                </span><span class="n">Server</span><span class="w"> </span><span class="n">svr</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">allServers</span><span class="o">[</span><span class="n">i</span><span class="o">]</span><span class="p">;</span><span class="w"></span>
<span class="w">                </span><span class="c1">// 获取 ping 之前的服务器状态</span><span class="w"></span>
<span class="w">                </span><span class="kt">boolean</span><span class="w"> </span><span class="n">oldIsAlive</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">svr</span><span class="p">.</span><span class="na">isAlive</span><span class="p">();</span><span class="w"></span>

<span class="w">                </span><span class="c1">// 将该服务器状态改为当前获取到的状态</span><span class="w"></span>
<span class="w">                </span><span class="n">svr</span><span class="p">.</span><span class="na">setAlive</span><span class="p">(</span><span class="n">isAlive</span><span class="p">);</span><span class="w"></span>

<span class="w">                </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">oldIsAlive</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">isAlive</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="c1">// 如果之前状态与当前获取的状态不一致</span><span class="w"></span>
<span class="w">                    </span><span class="c1">// 加入到状态更改过的服务器列表中</span><span class="w"></span>
<span class="w">                    </span><span class="n">changedServers</span><span class="p">.</span><span class="na">add</span><span class="p">(</span><span class="n">svr</span><span class="p">);</span><span class="w"></span>
<span class="w">                    </span><span class="c1">// 输出日志：当前服务器状态修改</span><span class="w"></span>
<span class="w">                    </span><span class="n">logger</span><span class="p">.</span><span class="na">debug</span><span class="p">(</span><span class="s">&quot;LoadBalancer [{}]:  Server [{}] status changed to {}&quot;</span><span class="p">,</span><span class="w"> </span>
<span class="w">                        </span><span class="n">name</span><span class="p">,</span><span class="w"> </span><span class="n">svr</span><span class="p">.</span><span class="na">getId</span><span class="p">(),</span><span class="w"> </span><span class="p">(</span><span class="n">isAlive</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="s">&quot;ALIVE&quot;</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="s">&quot;DEAD&quot;</span><span class="p">));</span><span class="w"></span>
<span class="w">                </span><span class="p">}</span><span class="w"></span>

<span class="w">                </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">isAlive</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">                    </span><span class="c1">// 如果获取到的当前状态为 true（存活UP状态）</span><span class="w"></span>
<span class="w">                    </span><span class="c1">// 则将该服务器加入到 newUpList 中，用于后面更新至存活服务器列表</span><span class="w"></span>
<span class="w">                    </span><span class="n">newUpList</span><span class="p">.</span><span class="na">add</span><span class="p">(</span><span class="n">svr</span><span class="p">);</span><span class="w"></span>
<span class="w">                </span><span class="p">}</span><span class="w"></span>
<span class="w">            </span><span class="p">}</span><span class="w"></span>
<span class="w">            </span><span class="c1">// 更新存活服务器列表，需要加写锁，避免并发问题</span><span class="w"></span>
<span class="w">            </span><span class="n">upLock</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">upServerLock</span><span class="p">.</span><span class="na">writeLock</span><span class="p">();</span><span class="w"></span>
<span class="w">            </span><span class="n">upLock</span><span class="p">.</span><span class="na">lock</span><span class="p">();</span><span class="w"></span>
<span class="w">            </span><span class="n">upServerList</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">newUpList</span><span class="p">;</span><span class="w"></span>
<span class="w">            </span><span class="n">upLock</span><span class="p">.</span><span class="na">unlock</span><span class="p">();</span><span class="w"></span>

<span class="w">            </span><span class="c1">// 通知服务器状态修改</span><span class="w"></span>
<span class="w">            </span><span class="n">notifyServerStatusChangeListener</span><span class="p">(</span><span class="n">changedServers</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="w"> </span><span class="k">finally</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">            </span><span class="n">pingInProgress</span><span class="p">.</span><span class="na">set</span><span class="p">(</span><span class="kc">false</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div></table></div> <p>该定时任务的大致流程为：</p> <p>1、首先将用 CAS 来修改 pingInProgress （AtomicBoolean 对象），如果修改不成功，则表示当前有其他线程正在发送 ping 请求，并且还没有执行完毕，所以当前操作可以不再执行。</p> <p>2、加读锁获取当前服务列表。</p> <p>3、通过 IPingStrategy 向每个服务器发送 ping 请求，得到一个布尔值的结果集。</p> <p>3、遍历之前获取到的 Server List，判断服务状态是否有变化，并更新服务列表。（其中状态更改的服务器将会加入到 changedServers 列表中，ping 请求后依然存活的服务会加入到 newUpList 中）</p> <p>4、最后加写锁更新 UP 状态的服务器列表，并<strong>通知服务状态改变</strong>。(有兴趣的话，此处可以查看一下ServerStatusChangeListener 的实现类是哪个，再看具体做了什么操作)</p> <p>5、全部执行完成后，将 pingInProgress 改为 false。</p> <h2 id="_6">总结<a class="headerlink" href="#_6" title="Permanent link">&para;</a></h2> <p>由此可见，Ribbon的负载均衡，主要是通过 LoadBalancerClient 来实现的，而 Load’BalancerClient 又将具体实现交给了 ILoadBalancer 来处理，ILoadBalancer 通过配置 IRule、IPing 等信息，向 Eureka 获取服务注册列表，并且在初始化时开启一个定时任务，10s 一次向 EurekaClient 发送 ping 请求，来判断服务的可用性，如果服务的可用性发生改变或者服务数量与之前的不一致，则更新当前服务器列表或重新拉取。最后 ILoadBalancer 获取到这些服务列表之后，便可以根据 IRule 来进行负载均衡。</p> <p>而 RestTemplate 被 @LoadBalanced 注解后，能够实现负载均衡，主要是通过给 RestTemplate 添加拦截器，在请求前通过拦截器（负载均衡）获取到真正的请求地址，最后进行服务调用。</p> <h2 id="ref">Ref<a class="headerlink" href="#ref" title="Permanent link">&para;</a></h2> <p><a href="https://github.com/Netflix/ribbon.git">Ribbon 源码</a></p> <p><a href="https://github.com/spring-cloud/spring-cloud-commons.git">Spring Cloud Commons 源码</a></p> <p><a href="https://github.com/spring-cloud/spring-cloud-netflix.git">Spring Cloud Netflix 源码</a></p> <p><a href="https://cloud.spring.io/spring-cloud-static/spring-cloud-netflix/2.1.3.RELEASE/single/spring-cloud-netflix.html#spring-cloud-ribbon">Spring Cloud Netflix Ribbon 官方文档</a></p> <p><a href="https://github.com/aCoder2013/blog/issues/29">Spring Cloud Ribbon踩坑记录及原理解析</a></p> <p><a href="http://www.spring4all.com/article/230">Ribbon原理分析 - Spring For All</a></p> <h2 id="__comments">评论</h2> <div id="disqus_thread"></div> <script>var disqus_config=function(){this.page.url="https://yongqilei.github.io/java/spring-cloud-ribbon/",this.page.identifier="java/spring-cloud-ribbon/"};if("undefined"==typeof DISQUS){var script=document.createElement("script");script.async=!0,script.src="https://programming-tech-sharing.disqus.com/embed.js",script.setAttribute("data-timestamp",Date.now()),document.body.appendChild(script)}else DISQUS.reset({reload:!0,config:disqus_config})</script> </article> </div> </div> <a href="#" class="md-top md-icon" data-md-component="top" data-md-state="hidden"> <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8v12z"/></svg> 回到页面顶部 </a> </main> <footer class="md-footer"> <nav class="md-footer__inner md-grid" aria-label="页脚"> <a href="../jvm-breakdown/" class="md-footer__link md-footer__link--prev" aria-label="上一页: JVM 内存区域学习笔记" rel="prev"> <div class="md-footer__button md-icon"> <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg> </div> <div class="md-footer__title"> <div class="md-ellipsis"> <span class="md-footer__direction"> 上一页 </span> JVM 内存区域学习笔记 </div> </div> </a> <a href="../interview/bytedance-interview/" class="md-footer__link md-footer__link--next" aria-label="下一页: 字节跳动 Java 面试题" rel="next"> <div class="md-footer__title"> <div class="md-ellipsis"> <span class="md-footer__direction"> 下一页 </span> 字节跳动 Java 面试题 </div> </div> <div class="md-footer__button md-icon"> <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M4 11v2h12l-5.5 5.5 1.42 1.42L19.84 12l-7.92-7.92L10.5 5.5 16 11H4z"/></svg> </div> </a> </nav> <div class="md-footer-meta md-typeset"> <div class="md-footer-meta__inner md-grid"> <div class="md-copyright"> <div class="md-copyright__highlight"> Copyright &copy; 2021 - 2022 Eng Learning by Torres </div> Made with <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener"> Material for MkDocs </a> </div> </div> </div> </footer> </div> <div class="md-dialog" data-md-component="dialog"> <div class="md-dialog__inner md-typeset"></div> </div> <script id="__config" type="application/json">{"base": "../..", "features": ["search.suggest", "search.highlight", "search.share", "navigation.tabs", "navigation.instant", "navigation.tracking", "navigation.top", "content.tabs.link"], "search": "../../assets/javascripts/workers/search.361d90f1.min.js", "translations": {"clipboard.copied": "\u5df2\u590d\u5236", "clipboard.copy": "\u590d\u5236", "search.config.lang": "ja", "search.config.pipeline": "trimmer, stemmer", "search.config.separator": "[\\uff0c\\u3002]+", "search.placeholder": "\u641c\u7d22", "search.result.more.one": "\u5728\u8be5\u9875\u4e0a\u8fd8\u6709 1 \u4e2a\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.more.other": "\u5728\u8be5\u9875\u4e0a\u8fd8\u6709 # \u4e2a\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.none": "\u6ca1\u6709\u627e\u5230\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.one": "\u627e\u5230 1 \u4e2a\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.other": "# \u4e2a\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.placeholder": "\u952e\u5165\u4ee5\u5f00\u59cb\u641c\u7d22", "search.result.term.missing": "\u7f3a\u5c11", "select.version.title": "\u9009\u62e9\u5f53\u524d\u7248\u672c"}}</script> <script src="../../assets/javascripts/bundle.289a2a4b.min.js"></script> <script src="../../javascripts/mathjax.js"></script> <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script> <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script> 