 <!doctype html> <html lang="zh" class="no-js"> <head> <meta charset="utf-8"> <meta name="viewport" content="width=device-width,initial-scale=1"> <meta name="description" content="Programming Tech Sharing 是我用来整合知识的一个站点，主要面向编程知识。"> <meta name="author" content="Torres Lei"> <link rel="canonical" href="https://yongqilei.github.io/java/jvm-breakdown/"> <link rel="icon" href="../../favicon.ico"> <meta name="generator" content="mkdocs-1.3.1, mkdocs-material-8.1.4"> <title>JVM Inteview - Programming Tech Sharing</title> <link rel="stylesheet" href="../../assets/stylesheets/main.bb3983ee.min.css"> <link rel="stylesheet" href="../../assets/stylesheets/palette.e6a45f82.min.css"> <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin> <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Fira+Sans:300,400,400i,700%7CFira+Mono&display=fallback"> <style>:root{--md-text-font:"Fira Sans";--md-code-font:"Fira Mono"}</style> <script>__md_scope=new URL("../..",location),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script> </head> <body dir="ltr" data-md-color-scheme="" data-md-color-primary="indigo" data-md-color-accent="indigo"> <script>var palette=__md_get("__palette");if(palette&&"object"==typeof palette.color)for(var[key,value]of Object.entries(palette.color))document.body.setAttribute("data-md-color-"+key,value)</script> <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off"> <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off"> <label class="md-overlay" for="__drawer"></label> <div data-md-component="skip"> <a href="#purpose" class="md-skip"> 跳转至 </a> </div> <div data-md-component="announce"> </div> <header class="md-header" data-md-component="header"> <nav class="md-header__inner md-grid" aria-label="页眉"> <a href="../.." title="Programming Tech Sharing" class="md-header__button md-logo" aria-label="Programming Tech Sharing" data-md-component="logo"> <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M6 20h7v2H6c-1.11 0-2-.89-2-2V4a2 2 0 0 1 2-2h12a2 2 0 0 1 2 2v8.54l-1.5-.82-.5.28V4h-5v8l-2.5-2.25L8 12V4H6v16m18-3-5.5-3-5.5 3 5.5 3 5.5-3m-9 2.09v2L18.5 23l3.5-1.91v-2L18.5 21 15 19.09z"/></svg> </a> <label class="md-header__button md-icon" for="__drawer"> <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2z"/></svg> </label> <div class="md-header__title" data-md-component="header-title"> <div class="md-header__ellipsis"> <div class="md-header__topic"> <span class="md-ellipsis"> Programming Tech Sharing </span> </div> <div class="md-header__topic" data-md-component="header-topic"> <span class="md-ellipsis"> JVM Inteview </span> </div> </div> </div> <form class="md-header__option" data-md-component="palette"> <input class="md-option" data-md-color-media="" data-md-color-scheme="" data-md-color-primary="indigo" data-md-color-accent="indigo" aria-label="Switch to dark mode" type="radio" name="__palette" id="__palette_1"> <label class="md-header__button md-icon" title="Switch to dark mode" for="__palette_2" hidden> <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M17 7H7a5 5 0 0 0-5 5 5 5 0 0 0 5 5h10a5 5 0 0 0 5-5 5 5 0 0 0-5-5m0 8a3 3 0 0 1-3-3 3 3 0 0 1 3-3 3 3 0 0 1 3 3 3 3 0 0 1-3 3z"/></svg> </label> <input class="md-option" data-md-color-media="" data-md-color-scheme="slate" data-md-color-primary="red" data-md-color-accent="red" aria-label="Switch to light mode" type="radio" name="__palette" id="__palette_2"> <label class="md-header__button md-icon" title="Switch to light mode" for="__palette_1" hidden> <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M17 6H7c-3.31 0-6 2.69-6 6s2.69 6 6 6h10c3.31 0 6-2.69 6-6s-2.69-6-6-6zm0 10H7c-2.21 0-4-1.79-4-4s1.79-4 4-4h10c2.21 0 4 1.79 4 4s-1.79 4-4 4zM7 9c-1.66 0-3 1.34-3 3s1.34 3 3 3 3-1.34 3-3-1.34-3-3-3z"/></svg> </label> </form> <label class="md-header__button md-icon" for="__search"> <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5z"/></svg> </label> <div class="md-search" data-md-component="search" role="dialog"> <label class="md-search__overlay" for="__search"></label> <div class="md-search__inner" role="search"> <form class="md-search__form" name="search"> <input class="md-search__input" name="query" aria-label="搜索" placeholder="搜索" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required> <label class="md-search__icon md-icon" for="__search"> <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5z"/></svg> <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg> </label> <nav class="md-search__options" aria-label="查找"> <a href="javascript:void(0)" class="md-search__icon md-icon" aria-label="分享" data-clipboard data-clipboard-text="" data-md-component="search-share" tabindex="-1"> <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M18 16.08c-.76 0-1.44.3-1.96.77L8.91 12.7c.05-.23.09-.46.09-.7 0-.24-.04-.47-.09-.7l7.05-4.11c.54.5 1.25.81 2.04.81a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3c0 .24.04.47.09.7L8.04 9.81C7.5 9.31 6.79 9 6 9a3 3 0 0 0-3 3 3 3 0 0 0 3 3c.79 0 1.5-.31 2.04-.81l7.12 4.15c-.05.21-.08.43-.08.66 0 1.61 1.31 2.91 2.92 2.91 1.61 0 2.92-1.3 2.92-2.91A2.92 2.92 0 0 0 18 16.08z"/></svg> </a> <button type="reset" class="md-search__icon md-icon" aria-label="清空当前内容" tabindex="-1"> <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41z"/></svg> </button> </nav> <div class="md-search__suggest" data-md-component="search-suggest"></div> </form> <div class="md-search__output"> <div class="md-search__scrollwrap" data-md-scrollfix> <div class="md-search-result" data-md-component="search-result"> <div class="md-search-result__meta"> 正在初始化搜索引擎 </div> <ol class="md-search-result__list"></ol> </div> </div> </div> </div> </div> <div class="md-header__source"> <a href="https://github.com/yongqilei/yongqilei.github.io" title="前往仓库" class="md-source" data-md-component="source"> <div class="md-source__icon md-icon"> <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 480 512"><path d="M186.1 328.7c0 20.9-10.9 55.1-36.7 55.1s-36.7-34.2-36.7-55.1 10.9-55.1 36.7-55.1 36.7 34.2 36.7 55.1zM480 278.2c0 31.9-3.2 65.7-17.5 95-37.9 76.6-142.1 74.8-216.7 74.8-75.8 0-186.2 2.7-225.6-74.8-14.6-29-20.2-63.1-20.2-95 0-41.9 13.9-81.5 41.5-113.6-5.2-15.8-7.7-32.4-7.7-48.8 0-21.5 4.9-32.3 14.6-51.8 45.3 0 74.3 9 108.8 36 29-6.9 58.8-10 88.7-10 27 0 54.2 2.9 80.4 9.2 34-26.7 63-35.2 107.8-35.2 9.8 19.5 14.6 30.3 14.6 51.8 0 16.4-2.6 32.7-7.7 48.2 27.5 32.4 39 72.3 39 114.2zm-64.3 50.5c0-43.9-26.7-82.6-73.5-82.6-18.9 0-37 3.4-56 6-14.9 2.3-29.8 3.2-45.1 3.2-15.2 0-30.1-.9-45.1-3.2-18.7-2.6-37-6-56-6-46.8 0-73.5 38.7-73.5 82.6 0 87.8 80.4 101.3 150.4 101.3h48.2c70.3 0 150.6-13.4 150.6-101.3zm-82.6-55.1c-25.8 0-36.7 34.2-36.7 55.1s10.9 55.1 36.7 55.1 36.7-34.2 36.7-55.1-10.9-55.1-36.7-55.1z"/></svg> </div> <div class="md-source__repository"> Programming Space </div> </a> </div> </nav> </header> <div class="md-container" data-md-component="container"> <nav class="md-tabs" aria-label="标签" data-md-component="tabs"> <div class="md-tabs__inner md-grid"> <ul class="md-tabs__list"> <li class="md-tabs__item"> <a href="../.." class="md-tabs__link"> 简介 </a> </li> <li class="md-tabs__item"> <a href="../" class="md-tabs__link md-tabs__link--active"> Java </a> </li> <li class="md-tabs__item"> <a href="../../cloud/" class="md-tabs__link"> 云原生 </a> </li> <li class="md-tabs__item"> <a href="../../algo/leetcode/" class="md-tabs__link"> 算法 </a> </li> <li class="md-tabs__item"> <a href="../../bigdata/" class="md-tabs__link"> 大数据 </a> </li> </ul> </div> </nav> <main class="md-main" data-md-component="main"> <div class="md-main__inner md-grid"> <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation"> <div class="md-sidebar__scrollwrap"> <div class="md-sidebar__inner"> <nav class="md-nav md-nav--primary md-nav--lifted" aria-label="导航栏" data-md-level="0"> <label class="md-nav__title" for="__drawer"> <a href="../.." title="Programming Tech Sharing" class="md-nav__button md-logo" aria-label="Programming Tech Sharing" data-md-component="logo"> <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M6 20h7v2H6c-1.11 0-2-.89-2-2V4a2 2 0 0 1 2-2h12a2 2 0 0 1 2 2v8.54l-1.5-.82-.5.28V4h-5v8l-2.5-2.25L8 12V4H6v16m18-3-5.5-3-5.5 3 5.5 3 5.5-3m-9 2.09v2L18.5 23l3.5-1.91v-2L18.5 21 15 19.09z"/></svg> </a> Programming Tech Sharing </label> <div class="md-nav__source"> <a href="https://github.com/yongqilei/yongqilei.github.io" title="前往仓库" class="md-source" data-md-component="source"> <div class="md-source__icon md-icon"> <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 480 512"><path d="M186.1 328.7c0 20.9-10.9 55.1-36.7 55.1s-36.7-34.2-36.7-55.1 10.9-55.1 36.7-55.1 36.7 34.2 36.7 55.1zM480 278.2c0 31.9-3.2 65.7-17.5 95-37.9 76.6-142.1 74.8-216.7 74.8-75.8 0-186.2 2.7-225.6-74.8-14.6-29-20.2-63.1-20.2-95 0-41.9 13.9-81.5 41.5-113.6-5.2-15.8-7.7-32.4-7.7-48.8 0-21.5 4.9-32.3 14.6-51.8 45.3 0 74.3 9 108.8 36 29-6.9 58.8-10 88.7-10 27 0 54.2 2.9 80.4 9.2 34-26.7 63-35.2 107.8-35.2 9.8 19.5 14.6 30.3 14.6 51.8 0 16.4-2.6 32.7-7.7 48.2 27.5 32.4 39 72.3 39 114.2zm-64.3 50.5c0-43.9-26.7-82.6-73.5-82.6-18.9 0-37 3.4-56 6-14.9 2.3-29.8 3.2-45.1 3.2-15.2 0-30.1-.9-45.1-3.2-18.7-2.6-37-6-56-6-46.8 0-73.5 38.7-73.5 82.6 0 87.8 80.4 101.3 150.4 101.3h48.2c70.3 0 150.6-13.4 150.6-101.3zm-82.6-55.1c-25.8 0-36.7 34.2-36.7 55.1s10.9 55.1 36.7 55.1 36.7-34.2 36.7-55.1-10.9-55.1-36.7-55.1z"/></svg> </div> <div class="md-source__repository"> Programming Space </div> </a> </div> <ul class="md-nav__list" data-md-scrollfix> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_1" type="checkbox" id="__nav_1"> <label class="md-nav__link" for="__nav_1"> 简介 <span class="md-nav__icon md-icon"></span> </label> <nav class="md-nav" aria-label="简介" data-md-level="1"> <label class="md-nav__title" for="__nav_1"> <span class="md-nav__icon md-icon"></span> 简介 </label> <ul class="md-nav__list" data-md-scrollfix> <li class="md-nav__item"> <a href="../.." class="md-nav__link"> Getting Started </a> </li> <li class="md-nav__item"> <a href="../../about/" class="md-nav__link"> 关于我 </a> </li> <li class="md-nav__item"> <a href="../../about-en/" class="md-nav__link"> About Me </a> </li> <li class="md-nav__item"> <a href="../../tags/" class="md-nav__link"> 标签 </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--active md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_2" type="checkbox" id="__nav_2" checked="checked"> <label class="md-nav__link" for="__nav_2"> Java <span class="md-nav__icon md-icon"></span> </label> <nav class="md-nav" aria-label="Java" data-md-level="1"> <label class="md-nav__title" for="__nav_2"> <span class="md-nav__icon md-icon"></span> Java </label> <ul class="md-nav__list" data-md-scrollfix> <li class="md-nav__item"> <a href="../" class="md-nav__link"> Java简介 </a> </li> <li class="md-nav__item"> <a href="../synchronized/" class="md-nav__link"> Synchronized 学习笔记 </a> </li> <li class="md-nav__item"> <a href="../volatile/" class="md-nav__link"> Volatile 学习笔记 </a> </li> <li class="md-nav__item md-nav__item--active md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_2_4" type="checkbox" id="__nav_2_4" checked="checked"> <label class="md-nav__link" for="__nav_2_4"> JVM <span class="md-nav__icon md-icon"></span> </label> <nav class="md-nav" aria-label="JVM" data-md-level="2"> <label class="md-nav__title" for="__nav_2_4"> <span class="md-nav__icon md-icon"></span> JVM </label> <ul class="md-nav__list" data-md-scrollfix> <li class="md-nav__item"> <a href="../garbage-collector/" class="md-nav__link"> Java 垃圾收集器 </a> </li> <li class="md-nav__item md-nav__item--active"> <input class="md-nav__toggle md-toggle" data-md-toggle="toc" type="checkbox" id="__toc"> <label class="md-nav__link md-nav__link--active" for="__toc"> JVM 内存区域学习笔记 <span class="md-nav__icon md-icon"></span> </label> <a href="./" class="md-nav__link md-nav__link--active"> JVM 内存区域学习笔记 </a> <nav class="md-nav md-nav--secondary" aria-label="目录"> <label class="md-nav__title" for="__toc"> <span class="md-nav__icon md-icon"></span> 目录 </label> <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix> <li class="md-nav__item"> <a href="#purpose" class="md-nav__link"> Purpose </a> </li> <li class="md-nav__item"> <a href="#java-7-java-8" class="md-nav__link"> Java 7 到 Java 8 的更新 </a> </li> <li class="md-nav__item"> <a href="#java" class="md-nav__link"> Java 虚拟机内存区域 </a> </li> <li class="md-nav__item"> <a href="#run-time-data-areas-" class="md-nav__link"> Run-Time Data Areas - 运行时数据区 </a> <nav class="md-nav" aria-label="Run-Time Data Areas - 运行时数据区"> <ul class="md-nav__list"> <li class="md-nav__item"> <a href="#the-pc-register-" class="md-nav__link"> The PC Register - 程序计数器寄存器 </a> </li> <li class="md-nav__item"> <a href="#java-virtual-machine-stacks-jvm" class="md-nav__link"> Java Virtual Machine Stacks - JVM 栈 </a> </li> <li class="md-nav__item"> <a href="#heap-" class="md-nav__link"> Heap - 堆 </a> </li> <li class="md-nav__item"> <a href="#method-area-java-8" class="md-nav__link"> Method Area - 方法区（Java 8 之后已经移除） </a> </li> <li class="md-nav__item"> <a href="#run-time-constant-pool-" class="md-nav__link"> Run-Time Constant Pool - 运行时常量池 </a> </li> <li class="md-nav__item"> <a href="#native-method-stacks-" class="md-nav__link"> Native Method Stacks - 本地方法栈 </a> </li> <li class="md-nav__item"> <a href="#metaspace" class="md-nav__link"> Metaspace </a> </li> </ul> </nav> </li> <li class="md-nav__item"> <a href="#metaspace-" class="md-nav__link"> Metaspace - 元空间 </a> </li> <li class="md-nav__item"> <a href="#frames-" class="md-nav__link"> Frames - 栈帧 </a> <nav class="md-nav" aria-label="Frames - 栈帧"> <ul class="md-nav__list"> <li class="md-nav__item"> <a href="#local-variables-" class="md-nav__link"> Local Variables - 本地变量 </a> </li> <li class="md-nav__item"> <a href="#operand-stacks-" class="md-nav__link"> Operand Stacks - 操作数栈 </a> </li> <li class="md-nav__item"> <a href="#dynamic-linking-" class="md-nav__link"> Dynamic Linking - 动态链接 </a> </li> </ul> </nav> </li> <li class="md-nav__item"> <a href="#conclusion" class="md-nav__link"> Conclusion </a> </li> </ul> </nav> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_2_5" type="checkbox" id="__nav_2_5"> <label class="md-nav__link" for="__nav_2_5"> Spring <span class="md-nav__icon md-icon"></span> </label> <nav class="md-nav" aria-label="Spring" data-md-level="2"> <label class="md-nav__title" for="__nav_2_5"> <span class="md-nav__icon md-icon"></span> Spring </label> <ul class="md-nav__list" data-md-scrollfix> <li class="md-nav__item"> <a href="../spring-cloud-ribbon/" class="md-nav__link"> Spring Cloud Ribbon </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_2_6" type="checkbox" id="__nav_2_6"> <label class="md-nav__link" for="__nav_2_6"> 面试 <span class="md-nav__icon md-icon"></span> </label> <nav class="md-nav" aria-label="面试" data-md-level="2"> <label class="md-nav__title" for="__nav_2_6"> <span class="md-nav__icon md-icon"></span> 面试 </label> <ul class="md-nav__list" data-md-scrollfix> <li class="md-nav__item"> <a href="../interview/bytedance-interview/" class="md-nav__link"> 字节跳动 Java 面试题 </a> </li> </ul> </nav> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_3" type="checkbox" id="__nav_3"> <label class="md-nav__link" for="__nav_3"> 云原生 <span class="md-nav__icon md-icon"></span> </label> <nav class="md-nav" aria-label="云原生" data-md-level="1"> <label class="md-nav__title" for="__nav_3"> <span class="md-nav__icon md-icon"></span> 云原生 </label> <ul class="md-nav__list" data-md-scrollfix> <li class="md-nav__item"> <a href="../../cloud/" class="md-nav__link"> 云原生简介 </a> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_3_2" type="checkbox" id="__nav_3_2"> <label class="md-nav__link" for="__nav_3_2"> Golang <span class="md-nav__icon md-icon"></span> </label> <nav class="md-nav" aria-label="Golang" data-md-level="2"> <label class="md-nav__title" for="__nav_3_2"> <span class="md-nav__icon md-icon"></span> Golang </label> <ul class="md-nav__list" data-md-scrollfix> <li class="md-nav__item"> <a href="../../cloud/golang-basics/" class="md-nav__link"> Golang基础知识 </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_3_3" type="checkbox" id="__nav_3_3"> <label class="md-nav__link" for="__nav_3_3"> Kubernetes <span class="md-nav__icon md-icon"></span> </label> <nav class="md-nav" aria-label="Kubernetes" data-md-level="2"> <label class="md-nav__title" for="__nav_3_3"> <span class="md-nav__icon md-icon"></span> Kubernetes </label> <ul class="md-nav__list" data-md-scrollfix> <li class="md-nav__item"> <a href="../../cloud/kubernetes-on-centos/" class="md-nav__link"> Kubernetes on CentOS </a> </li> <li class="md-nav__item"> <a href="../../cloud/kubernetes-installation-on-centos/" class="md-nav__link"> 在CentOS上安装K8S </a> </li> <li class="md-nav__item"> <a href="../../cloud/kubernetes-java-commands/" class="md-nav__link"> Kubernetes中Java应用相关操作 </a> </li> </ul> </nav> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_4" type="checkbox" id="__nav_4"> <label class="md-nav__link" for="__nav_4"> 算法 <span class="md-nav__icon md-icon"></span> </label> <nav class="md-nav" aria-label="算法" data-md-level="1"> <label class="md-nav__title" for="__nav_4"> <span class="md-nav__icon md-icon"></span> 算法 </label> <ul class="md-nav__list" data-md-scrollfix> <li class="md-nav__item"> <a href="../../algo/leetcode/" class="md-nav__link"> Leetcode刷题记录 </a> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_4_2" type="checkbox" id="__nav_4_2"> <label class="md-nav__link" for="__nav_4_2"> LeetCode <span class="md-nav__icon md-icon"></span> </label> <nav class="md-nav" aria-label="LeetCode" data-md-level="2"> <label class="md-nav__title" for="__nav_4_2"> <span class="md-nav__icon md-icon"></span> LeetCode </label> <ul class="md-nav__list" data-md-scrollfix> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_4_2_1" type="checkbox" id="__nav_4_2_1"> <label class="md-nav__link" for="__nav_4_2_1"> Daily <span class="md-nav__icon md-icon"></span> </label> <nav class="md-nav" aria-label="Daily" data-md-level="3"> <label class="md-nav__title" for="__nav_4_2_1"> <span class="md-nav__icon md-icon"></span> Daily </label> <ul class="md-nav__list" data-md-scrollfix> <li class="md-nav__item"> <a href="../../algo/leetcode/daily/2022-01-04/" class="md-nav__link"> 2022/01/04 - 913. 猫和老鼠 </a> </li> <li class="md-nav__item"> <a href="../../algo/leetcode/daily/2022-01-05/" class="md-nav__link"> 2021/01/05 - 1576. 替换所有的问号 </a> </li> <li class="md-nav__item"> <a href="../../algo/leetcode/daily/2022-01-07/" class="md-nav__link"> 2022/01/07 - 1614. 括号的最大嵌套深度 </a> </li> <li class="md-nav__item"> <a href="../../algo/leetcode/daily/2022-01-07-en/" class="md-nav__link"> 2022/01/07 - 382. Linked List Random Node </a> </li> <li class="md-nav__item"> <a href="../../algo/leetcode/daily/2022-01-08/" class="md-nav__link"> 2022/01/08 - 89. 格雷编码 </a> </li> <li class="md-nav__item"> <a href="../../algo/leetcode/daily/2022-01-09-en/" class="md-nav__link"> 2022/01/09 - 1041. Robot Bounded In Circle </a> </li> <li class="md-nav__item"> <a href="../../algo/leetcode/daily/2022-01-09/" class="md-nav__link"> 2022/01/09 - 1629. 按键持续时间最长的键 </a> </li> <li class="md-nav__item"> <a href="../../algo/leetcode/daily/2022-01-10/" class="md-nav__link"> 2022/01/10 - 306. 累加数 </a> </li> <li class="md-nav__item"> <a href="../../algo/leetcode/daily/2022-01-11/" class="md-nav__link"> 2022/01/11 - 1036. 逃离大迷宫 </a> </li> <li class="md-nav__item"> <a href="../../algo/leetcode/daily/2022-01-12-en/" class="md-nav__link"> 2022/01/12 - 701. Insert into a Binary Search Tree </a> </li> <li class="md-nav__item"> <a href="../../algo/leetcode/daily/2022-01-13/" class="md-nav__link"> 2022/01/13 - 747. 至少是其他数字两倍的最大数 </a> </li> <li class="md-nav__item"> <a href="../../algo/leetcode/daily/2022-01-14/" class="md-nav__link"> 2022/01/14 - 373. 查找和最小的 K 对数字 </a> </li> <li class="md-nav__item"> <a href="../../algo/leetcode/daily/2022-01-15-en/" class="md-nav__link"> 2022/01/15 - 1345. Jump Game IV </a> </li> <li class="md-nav__item"> <a href="../../algo/leetcode/daily/2022-01-15/" class="md-nav__link"> 2022/01/15 - 1716. 计算力扣银行的钱 </a> </li> <li class="md-nav__item"> <a href="../../algo/leetcode/daily/2022-01-16/" class="md-nav__link"> 2022/01/16 - 849. Maximize Distance to Closest Person </a> </li> <li class="md-nav__item"> <a href="../../algo/leetcode/daily/2022-01-17/" class="md-nav__link"> 2022/01/17 - 290. Word Pattern </a> </li> <li class="md-nav__item"> <a href="../../algo/leetcode/daily/2022-01-20/" class="md-nav__link"> 2022/01/20 - 875. Koko Eating Bananas </a> </li> <li class="md-nav__item"> <a href="../../algo/leetcode/daily/2022-01-21/" class="md-nav__link"> 2022/01/20 - 134. Gas Station </a> </li> <li class="md-nav__item"> <a href="../../algo/leetcode/daily/2022-01-26/" class="md-nav__link"> 2022/01/26 - 1305. All Elements in Two Binary Search Trees </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_4_2_2" type="checkbox" id="__nav_4_2_2"> <label class="md-nav__link" for="__nav_4_2_2"> 动态规划 <span class="md-nav__icon md-icon"></span> </label> <nav class="md-nav" aria-label="动态规划" data-md-level="3"> <label class="md-nav__title" for="__nav_4_2_2"> <span class="md-nav__icon md-icon"></span> 动态规划 </label> <ul class="md-nav__list" data-md-scrollfix> <li class="md-nav__item"> <a href="../../algo/leetcode/dp/188-best-time-to-buy-and-sell-stock-iv/" class="md-nav__link"> 188. 买卖股票的最佳时机 IV </a> </li> <li class="md-nav__item"> <a href="../../algo/leetcode/dp/309-best-time-to-buy-and-sell-stock-with-cooldown/" class="md-nav__link"> 309. 最佳买卖股票时机含冷冻期 </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_4_2_3" type="checkbox" id="__nav_4_2_3"> <label class="md-nav__link" for="__nav_4_2_3"> 字符串系列 <span class="md-nav__icon md-icon"></span> </label> <nav class="md-nav" aria-label="字符串系列" data-md-level="3"> <label class="md-nav__title" for="__nav_4_2_3"> <span class="md-nav__icon md-icon"></span> 字符串系列 </label> <ul class="md-nav__list" data-md-scrollfix> <li class="md-nav__item"> <a href="../../algo/leetcode/string/string-to-integer-atoi/" class="md-nav__link"> 8. String to Integer (atoi) </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_4_2_4" type="checkbox" id="__nav_4_2_4"> <label class="md-nav__link" for="__nav_4_2_4"> 树系列 <span class="md-nav__icon md-icon"></span> </label> <nav class="md-nav" aria-label="树系列" data-md-level="3"> <label class="md-nav__title" for="__nav_4_2_4"> <span class="md-nav__icon md-icon"></span> 树系列 </label> <ul class="md-nav__list" data-md-scrollfix> <li class="md-nav__item"> <a href="../../algo/leetcode/tree/98-validate-binary-search-tree/" class="md-nav__link"> 98. Validate Binary Search Tree </a> </li> <li class="md-nav__item"> <a href="../../algo/leetcode/tree/102-binary-tree-level-order-traversal/" class="md-nav__link"> 102. Binary Tree Level Order Traversal </a> </li> <li class="md-nav__item"> <a href="../../algo/leetcode/tree/103-binary-tree-zigzag-level-order-traversal/" class="md-nav__link"> 103. Binary Tree Zigzag Level Order Traversal </a> </li> <li class="md-nav__item"> <a href="../../algo/leetcode/tree/107-binary-tree-level-order-traversal-ii/" class="md-nav__link"> 107. Binary Tree Level Order Traversal II </a> </li> <li class="md-nav__item"> <a href="../../algo/leetcode/tree/701-insert-into-a-binary-search-tree/" class="md-nav__link"> 701. Insert into a Binary Search Tree </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_4_2_5" type="checkbox" id="__nav_4_2_5"> <label class="md-nav__link" for="__nav_4_2_5"> 二分查找系列 <span class="md-nav__icon md-icon"></span> </label> <nav class="md-nav" aria-label="二分查找系列" data-md-level="3"> <label class="md-nav__title" for="__nav_4_2_5"> <span class="md-nav__icon md-icon"></span> 二分查找系列 </label> <ul class="md-nav__list" data-md-scrollfix> <li class="md-nav__item"> <a href="../../algo/leetcode/binary-search/33-search-in-rotated-sorted-array/" class="md-nav__link"> 33. Search in Rotated Sorted Array </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_4_2_6" type="checkbox" id="__nav_4_2_6"> <label class="md-nav__link" for="__nav_4_2_6"> 回溯系列 <span class="md-nav__icon md-icon"></span> </label> <nav class="md-nav" aria-label="回溯系列" data-md-level="3"> <label class="md-nav__title" for="__nav_4_2_6"> <span class="md-nav__icon md-icon"></span> 回溯系列 </label> <ul class="md-nav__list" data-md-scrollfix> <li class="md-nav__item"> <a href="../../algo/leetcode/backtrack/22-generate-parentheses/" class="md-nav__link"> 22. Generate Parentheses </a> </li> <li class="md-nav__item"> <a href="../../algo/leetcode/backtrack/17-letter-combination-of-a-phone-number/" class="md-nav__link"> 17. Letter Combinations of a Phone Number </a> </li> </ul> </nav> </li> <li class="md-nav__item"> <a href="../../algo/leetcode/number-of-islands/" class="md-nav__link"> 200. 岛屿数量 </a> </li> <li class="md-nav__item"> <a href="../../algo/leetcode/check-completeness-of-a-binary-tree/" class="md-nav__link"> 958. Check Completeness of a Binary Tree </a> </li> <li class="md-nav__item"> <a href="../../algo/leetcode/rotate-image-48/" class="md-nav__link"> 48. Rotate Image </a> </li> <li class="md-nav__item"> <a href="../../algo/leetcode/142-linked-list-cycle-ii/" class="md-nav__link"> 142. Linked List Cycle II </a> </li> <li class="md-nav__item"> <a href="../../algo/leetcode/string/6-zigzag-conversion/" class="md-nav__link"> 6. Zigzag Conversion </a> </li> </ul> </nav> </li> <li class="md-nav__item"> <a href="../../algo/union-find/" class="md-nav__link"> 并查集 </a> </li> <li class="md-nav__item"> <a href="../../algo/manacher-palindrome/" class="md-nav__link"> Manacher算法 </a> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_4_5" type="checkbox" id="__nav_4_5"> <label class="md-nav__link" for="__nav_4_5"> 排序算法 <span class="md-nav__icon md-icon"></span> </label> <nav class="md-nav" aria-label="排序算法" data-md-level="2"> <label class="md-nav__title" for="__nav_4_5"> <span class="md-nav__icon md-icon"></span> 排序算法 </label> <ul class="md-nav__list" data-md-scrollfix> <li class="md-nav__item"> <a href="../../algo/selection-sort/" class="md-nav__link"> 选择排序 </a> </li> <li class="md-nav__item"> <a href="../../algo/insertion-sort/" class="md-nav__link"> 插入排序 </a> </li> <li class="md-nav__item"> <a href="../../algo/shell-sort/" class="md-nav__link"> 希尔排序 </a> </li> <li class="md-nav__item"> <a href="../../algo/merge-sort/" class="md-nav__link"> 归并排序 </a> </li> </ul> </nav> </li> <li class="md-nav__item"> <a href="../../algo/rabin-karp-algo/" class="md-nav__link"> Rabin Karp Algorithm - 字符串哈希算法 </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_5" type="checkbox" id="__nav_5"> <label class="md-nav__link" for="__nav_5"> 大数据 <span class="md-nav__icon md-icon"></span> </label> <nav class="md-nav" aria-label="大数据" data-md-level="1"> <label class="md-nav__title" for="__nav_5"> <span class="md-nav__icon md-icon"></span> 大数据 </label> <ul class="md-nav__list" data-md-scrollfix> <li class="md-nav__item"> <a href="../../bigdata/" class="md-nav__link"> 简介 </a> </li> <li class="md-nav__item"> <a href="../../bigdata/scala-basics/" class="md-nav__link"> Scala 基础知识学习笔记 </a> </li> </ul> </nav> </li> </ul> </nav> </div> </div> </div> <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc"> <div class="md-sidebar__scrollwrap"> <div class="md-sidebar__inner"> <nav class="md-nav md-nav--secondary" aria-label="目录"> <label class="md-nav__title" for="__toc"> <span class="md-nav__icon md-icon"></span> 目录 </label> <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix> <li class="md-nav__item"> <a href="#purpose" class="md-nav__link"> Purpose </a> </li> <li class="md-nav__item"> <a href="#java-7-java-8" class="md-nav__link"> Java 7 到 Java 8 的更新 </a> </li> <li class="md-nav__item"> <a href="#java" class="md-nav__link"> Java 虚拟机内存区域 </a> </li> <li class="md-nav__item"> <a href="#run-time-data-areas-" class="md-nav__link"> Run-Time Data Areas - 运行时数据区 </a> <nav class="md-nav" aria-label="Run-Time Data Areas - 运行时数据区"> <ul class="md-nav__list"> <li class="md-nav__item"> <a href="#the-pc-register-" class="md-nav__link"> The PC Register - 程序计数器寄存器 </a> </li> <li class="md-nav__item"> <a href="#java-virtual-machine-stacks-jvm" class="md-nav__link"> Java Virtual Machine Stacks - JVM 栈 </a> </li> <li class="md-nav__item"> <a href="#heap-" class="md-nav__link"> Heap - 堆 </a> </li> <li class="md-nav__item"> <a href="#method-area-java-8" class="md-nav__link"> Method Area - 方法区（Java 8 之后已经移除） </a> </li> <li class="md-nav__item"> <a href="#run-time-constant-pool-" class="md-nav__link"> Run-Time Constant Pool - 运行时常量池 </a> </li> <li class="md-nav__item"> <a href="#native-method-stacks-" class="md-nav__link"> Native Method Stacks - 本地方法栈 </a> </li> <li class="md-nav__item"> <a href="#metaspace" class="md-nav__link"> Metaspace </a> </li> </ul> </nav> </li> <li class="md-nav__item"> <a href="#metaspace-" class="md-nav__link"> Metaspace - 元空间 </a> </li> <li class="md-nav__item"> <a href="#frames-" class="md-nav__link"> Frames - 栈帧 </a> <nav class="md-nav" aria-label="Frames - 栈帧"> <ul class="md-nav__list"> <li class="md-nav__item"> <a href="#local-variables-" class="md-nav__link"> Local Variables - 本地变量 </a> </li> <li class="md-nav__item"> <a href="#operand-stacks-" class="md-nav__link"> Operand Stacks - 操作数栈 </a> </li> <li class="md-nav__item"> <a href="#dynamic-linking-" class="md-nav__link"> Dynamic Linking - 动态链接 </a> </li> </ul> </nav> </li> <li class="md-nav__item"> <a href="#conclusion" class="md-nav__link"> Conclusion </a> </li> </ul> </nav> </div> </div> </div> <div class="md-content" data-md-component="content"> <article class="md-content__inner md-typeset"> <a href="https://github.com/yongqilei/yongqilei.github.io/edit/master/docs/java/jvm-breakdown.md" title="编辑此页" class="md-content__button md-icon"> <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20.71 7.04c.39-.39.39-1.04 0-1.41l-2.34-2.34c-.37-.39-1.02-.39-1.41 0l-1.84 1.83 3.75 3.75M3 17.25V21h3.75L17.81 9.93l-3.75-3.75L3 17.25z"/></svg> </a> <h1>JVM 内存区域学习笔记</h1> <h2 id="purpose">Purpose<a class="headerlink" href="#purpose" title="Permanent link">&para;</a></h2> <p>这篇文章是用来记录 Java 面试时需要应对的 Java 虚拟机部分的问题。</p> <h2 id="java-7-java-8">Java 7 到 Java 8 的更新<a class="headerlink" href="#java-7-java-8" title="Permanent link">&para;</a></h2> <p><a href="http://openjdk.java.net/jeps/122">JEP 122: Remove the Permanent Generation</a></p> <p>在此文章中出现了这段话：</p> <div class="admonition info"> <p class="admonition-title">Info</p> <p>The proposed implementation will allocate class meta-data in native memory and move interned Strings and class statics to the Java heap. Hotspot will explicitly allocate and free the native memory for the class meta-data.</p> </div> <p>这次提出的实现会将类的元数据分配在本地内存中，并将 interned Strings 和类静态数据移入 Java 堆中。</p> <p>之前使用 <code>-XX:MaxPermSize</code> 来控制 Permanent Generation 的内存大小，现在可以使用 <code>-XX:MaxMetaspaceSize</code> 控制元空间的最大值了。</p> <h2 id="java">Java 虚拟机内存区域<a class="headerlink" href="#java" title="Permanent link">&para;</a></h2> <p>Java 7 和 Java 8 有两种不同的内存区域，我会将他们分开说明。</p> <p><img alt="JVM Memory Area" src="../images/jvm/jvm-memory-area.png"></p> <p>JVM 内存区域中还有一个特殊的部分，叫做 Code Cache (代码缓存)，code cache 是 JVM 用来存储 native code。它是位于连续内存块块上的单个堆数据结构。</p> <div class="admonition note"> <p class="admonition-title">Note</p> <p>这个就涉及到 Tiered Compilation 了，可以自行去看文档：<a href="https://docs.oracle.com/en/java/javase/11/vm/java-hotspot-virtual-machine-performance-enhancements.html">Java Virtual Machine Guide </a></p> </div> <h2 id="run-time-data-areas-">Run-Time Data Areas - 运行时数据区<a class="headerlink" href="#run-time-data-areas-" title="Permanent link">&para;</a></h2> <p>JVM 定义了各种各样在程序执行中使用的运行时数据区。一些是在 JVM 启动时创建并且只在 JVM 关闭时销毁，另外一些则是根据每个线程，线程的数据区是在线程创建时创建并在线程执行完毕时销毁。</p> <h3 id="the-pc-register-">The PC Register - 程序计数器寄存器<a class="headerlink" href="#the-pc-register-" title="Permanent link">&para;</a></h3> <div class="admonition tip"> <p class="admonition-title">Tip</p> <p>pc stands for program counter, so pc register equals to program counter register. 下文都将简称 pc register 为 程序计数器</p> </div> <p>JVM 支持同一时间许多线程的执行。每个 JVM 线程都有它自己的 pc 注册器。任何时间点线程都在执行单个方法的代码，如果这个方法不是 native 方法，则当前线程的程序计数器包含现在正在执行的 JVM 指令的地址。 而如果正在执行 native 方法，则该线程的程序计数器的值就是 undefined。（程序计数器足以保存特定平台上的 returnAddress 或 native 指针。）</p> <h3 id="java-virtual-machine-stacks-jvm">Java Virtual Machine Stacks - JVM 栈<a class="headerlink" href="#java-virtual-machine-stacks-jvm" title="Permanent link">&para;</a></h3> <p>每个线程都有个私有的栈空间，在线程创建时创建。栈空间是用来储存栈帧（frames）的。JVM 的堆栈类似于传统语言（eg. C）的堆栈：保存了本地变量和部分返回值，并在方法调用和返回中起到作用。因为 JVM 栈空间除了弹出 (pop) 和压入 (push) 栈帧不会被直接操作，所以栈帧可能是在堆中分配的。所以 JVM 栈的内存不需要是连续的。</p> <p>以上规范允许 JVM 栈拥有固定大小或者根据计算要求动态扩展和收缩。如果栈是固定大小，那么在创建栈的时候可以独立选择栈的大小。</p> <blockquote> <p>JVM 给程序员和用户提供了控制 JVM 栈初始化大小的功能，以及在动态扩展或收缩栈空间的情况下，指定最大和最小值。</p> </blockquote> <p>但是 JVM 栈也有一些例外情况（异常）：</p> <ul> <li> <p>如果说计算要求的栈空间比允许使用的空间还要大，JVM 会抛出一个 StackOverflowError 异常。</p> </li> <li> <p>如果栈空间可以动态扩展，但是没有足够的内存空间来实现扩展，或者没有足够的内存来为新的线程创建栈空间，则 JVM 会抛出<code>OutOfMemoryError</code>。</p> </li> </ul> <h3 id="heap-">Heap - 堆<a class="headerlink" href="#heap-" title="Permanent link">&para;</a></h3> <p>堆在 JVM 中是线程共享的，是给所有<strong>类实例</strong>和<strong>数组</strong>分配空间的运行时数据区。</p> <p>堆是在 JVM 启动时创建的。</p> <p>存储在堆中的对象由 <strong>GC</strong>（Garbage Collector, automatic storage management system） 回收。所以我们在 Java 中<strong>不会显式</strong>释放对象的内存。</p> <p>堆可以是固定大小或者动态扩展或者当大堆没有必要的时候收缩。</p> <p>堆的内存不需要连续。</p> <blockquote> <p>JVM 也给开发者提供了控制堆内存大小的参数</p> <p>-Xms size 设定堆内存最小值和初始值</p> <p>-Xmx size 指定对内存最大值</p> <p>-Xmn size 指定对内存中年轻代的初始值和最大值</p> </blockquote> <p>如果给对象分配内存时，堆内存不足了，JVM 会抛出<code>OutOfMemoryError</code>。</p> <p>在堆中，我们分出了两个部分：nursery (可称作年轻代 - young generation) 和 old space (老年代)。其中 nursery memory 又被氛围三个部分：一个 Eden memory 和两个 survivor memory (s0, s1)。绝大多数新创建的对象都被分配在 Eden Memory 中，当 Eden Memory 满了时，Minor GC 会将所有 eden memory 中的对象移到 survivor memory 中 (通常其中由很大一部分会被回收，未被回收的部分会移到 survivor 中)，并且 Minor GC 会检查 survivor 中的对象并将它们 (未被回收的部分) 移到另一个 survivor memory 中，所以在同一个时间点，会有一个 survivor memory 是空的。当对象在 survivor 中存活足够多的 cycle 后，会被移入 老年代内存中。</p> <p><img alt="" src="../images/jvm/jvm-breakdown-2.png"></p> <blockquote> <p>需要注意的是，Java HotSpot VM 在启动的时候，会在地址空间预留整个 Heap，但除非需要，否则不会为其分配物理内存。</p> </blockquote> <h3 id="method-area-java-8">Method Area - 方法区（Java 8 之后已经移除）<a class="headerlink" href="#method-area-java-8" title="Permanent link">&para;</a></h3> <p style="color:red">Java 8 之后已经移除了 Permanent Generation，方法区是 Java 虚拟机的逻辑概念。而在 HotSpot 中，Permanent Generation 就是它对这个概念的实现。</p> <p>对于上面的 Note，可以在 Oracle 的官方文档中找到答案：</p> <details class="note"> <summary>Java Virtual Machine Specification - Chapter 2.5.4</summary> <p>The Java Virtual Machine has a method area that is shared among all Java Virtual Machine threads. The method area is analogous to the storage area for compiled code of a conventional language or analogous to the "text" segment in an operating system process. It stores per-class structures such as the run-time constant pool, field and method data, and the code for methods and constructors, including the special methods (§2.9) used in class and instance initialization and interface initialization.</p> <p>The method area is created on virtual machine start-up. <strong>Although the method area is logically part of the heap</strong>, simple implementations may choose not to either garbage collect or compact it. This specification does not mandate the location of the method area or the policies used to manage compiled code. The method area may be of a fixed size or may be expanded as required by the computation and may be contracted if a larger method area becomes unnecessary. The memory for the method area does not need to be contiguous.</p> <p>A Java Virtual Machine implementation may provide the programmer or the user control over the initial size of the method area, as well as, in the case of a varying-size method area, control over the maximum and minimum method area size.</p> <p>The following exceptional condition is associated with the method area:</p> <p>If memory in the method area cannot be made available to satisfy an allocation request, the Java Virtual Machine throws an <code>OutOfMemoryError</code>.</p> </details> <p>上面粗体的部分提到：“<strong><em>虽然方法区是堆的逻辑部分</em></strong>”</p> <p>在上方的引用中我们可以找到，方法区是在 JVM 启动时创建，和堆一样。</p> <p>Permanent Generation 是在 Hotspot 的对方法区的实现。</p> <p>方法区存储 “per-class structure”，例如：</p> <ol> <li> <p>运行时常量池（run-time constant pool）：Interned Strings…</p> </li> <li> <p>field</p> </li> <li> <p>方法数据（method data）</p> </li> <li> <p>方法和构造器的代码（code for methods and constructors）</p> </li> <li> <p>用在接口和实例初始化的特殊方法</p> </li> <li> <p>类元数据</p> </li> </ol> <p>但是在 Java 8 后，类元数据被移到了Metaspace。</p> <h3 id="run-time-constant-pool-">Run-Time Constant Pool - 运行时常量池<a class="headerlink" href="#run-time-constant-pool-" title="Permanent link">&para;</a></h3> <p>运行时常量池是类文件中常量池表的每个类或每个接口的运行时表示，包含了从编译时已知的数字字符串到必须在运行时处理的方法和字段引用。</p> <p>它类似于传统编程语言中的符号表，只不过包含了更广泛的数据。</p> <p>在 Java 8 之前，运行时常量池是存在于方法区中的（在 HotSpot 虚拟机中位于 Permanent Generation 中），在 Java 8 之后，移到了堆中。</p> <h3 id="native-method-stacks-">Native Method Stacks - 本地方法栈<a class="headerlink" href="#native-method-stacks-" title="Permanent link">&para;</a></h3> <p>本地方法栈使 JVM 能够使用 native 方法，也就是说使用除开 Java 之外的其他语言开发的方法（例如：C语言，JVM 是 C 语言开发的）。</p> <p>通常来说，JVM 会为每个线程单独分配一个本地方法栈，所以本地方法栈也是线程私有的。</p> <p>以下两个异常是本地方法栈可能会出现的：</p> <ul> <li> <p>StackOverflowError：如果计算之后需要的内存比设置的最大本地方法栈还要大。</p> </li> <li> <p>OutOfMemoryError：堆内存不足时，无法为新的线程创建初始化的本地方法栈。</p> </li> </ul> <h3 id="metaspace">Metaspace<a class="headerlink" href="#metaspace" title="Permanent link">&para;</a></h3> <p><a href="#Metaspace---元空间">MetaSpace - 元空间</a></p> <h2 id="metaspace-">Metaspace - 元空间<a class="headerlink" href="#metaspace-" title="Permanent link">&para;</a></h2> <blockquote> <p>Metaspace 我主要参考 Thomas Stüfe 的文章，根据自己的理解，将其翻译下来。<a href="https://stuefe.de/about/">Thomas Stüfe</a> 是 OpenJDK 的开发者，他的文章应该靠谱。</p> </blockquote> <p><strong>Reference</strong>: <a href="https://stuefe.de/posts/metaspace/what-is-metaspace/">What is Metaspace</a></p> <p>Metaspace 是 JVM 用来存放类元数据 (class metadata) 的地方。类元数据是在 JVM 进程中 Java 类的运行时表示，简单来说就是 JVM 处理 Java 类所需要的所有信息。它包括但不限于：</p> <ul> <li> <p>KClass Structure: Java 类的运行时状态的虚拟机内部表示 (the VM-internal representation of runtime state of a java class)</p> </li> <li> <p>Method Metadata (方法元数据) - 方法的相关信息数据，包括字节码 (bytecode)，异常表 (exception table)，常量 (constant)，局部变量表 (local variables table)，参数信息等…</p> </li> <li> <p>常量池</p> </li> <li> <p>注解</p> </li> <li> <p>方法计数器收集方法调用次数，用来辅助 JIT 决策</p> </li> <li> <p>...</p> </li> </ul> <h2 id="frames-">Frames - 栈帧<a class="headerlink" href="#frames-" title="Permanent link">&para;</a></h2> <blockquote> <p>主要详细说明上文说到的栈帧。</p> </blockquote> <p>栈帧是用来储存数据和部分结果，执行动态链接，返回值，以及抛出异常。</p> <p>新的栈帧是在每次方法被调用时创建，并随着方法调用完成销毁（不管是否正常结束或抛出了异常）。栈帧是被线程创建且分配在JVM栈中。每个栈帧都有自己的本地变量数组，操作数栈以及一个当前方法的类的运行时常量池的引用。</p> <p><strong>当一个方法被调用时，一个栈帧会被压入JVM栈中，该栈帧被称为当前栈，而其吊用的方法是当前方法。如果该栈帧调用了另一个方法，则该栈帧将不是当前栈帧，一个新的栈帧会被压入JVM栈，当新的方法调用完成后，当前栈帧会被弹出JVM栈，上一个栈帧则变成当前栈帧了。</strong></p> <h3 id="local-variables-">Local Variables - 本地变量<a class="headerlink" href="#local-variables-" title="Permanent link">&para;</a></h3> <p>每个栈帧都含有一个被称为本地变量（local variables）的变量数组。</p> <p>单个局部变量能保存 boolean, byte, char, short, int, float, reference 或 returnAddress 的值。一对局部变量才能保存 long 或 double 的值（long或double需要占用两个连续地址的局部变量）。</p> <p>类方法调用时，任何被传入的参数的索引都是从 0 开始的。而在实例方法调用时，索引为 0 的局部变量是这个实例方法被调用的对象的引用（this），所有参数的索引都是从 1 开始。</p> <h3 id="operand-stacks-">Operand Stacks - 操作数栈<a class="headerlink" href="#operand-stacks-" title="Permanent link">&para;</a></h3> <p>每一个栈帧都含有一个后进先出(LIFO)的栈，叫做 operand stack (操作数栈)。</p> <p>栈帧创建的时候操作数栈是空的，JVM 会通过一些指令来加载常量或者局部变量的值或字段到操作数栈。其他一些 JVM 指令会从操作数栈中取出操作数，根据指令操作它们，并将结果再压入操作数栈。操作数栈也会被用来准备传入方法的参数和接收方法返回结果。</p> <p>举个🌰：</p> <p>JVM 使用 iadd (<a href="https://docs.oracle.com/javase/specs/jvms/se8/html/jvms-6.html#jvms-6.5.iadd">"iadd" Instruction</a>) 指令将两个 int 数字加在一起，JVM会要求这两个需要被加在一起的整型数字要在操作数栈的最顶端，前一个指令会将它们两个压入栈中。然后，它们两个会从操作数栈中被弹出，相加之后的结果会被压入操作数栈中。</p> <div class="admonition warning"> <p class="admonition-title">Warning</p> <p>必须以适合其类型的操作方式操作 operand stack 中的值。</p> </div> <p>在任何时候，操作数栈都有一个关联深度，其中 long 和 double 类型的值贡献两个单位的深度，而其它类型的值贡献一个单位的深度。</p> <h3 id="dynamic-linking-">Dynamic Linking - 动态链接<a class="headerlink" href="#dynamic-linking-" title="Permanent link">&para;</a></h3> <p>每个栈帧都包含对当前方法类型的运行时常量池的引用，以支持方法代码的动态链接。</p> <p>方法的 class file code 通过符号引用 (symbolic reference) 指向被调用的方法和被访问的参数。动态链接就是将这些符号引用转换成具体的方法引用，并且将参数访问转换成与这些参数相关联的存储结构的位移。</p> <h2 id="conclusion">Conclusion<a class="headerlink" href="#conclusion" title="Permanent link">&para;</a></h2> <p>Java 的内存区域有以下几个：</p> <ol> <li> <p>Heap</p> </li> <li> <p>JVM Stack</p> </li> <li> <p>Method Area （HotSpot中的实现为 Permanent Generation）</p> </li> <li> <p>Metaspace</p> </li> </ol> <p>其中 <strong>JVM Stack</strong> 中存储：</p> <ol> <li> <p>PC Register</p> </li> <li> <p>Native Method Stack</p> </li> <li> <p>Frames - 栈帧 a. 局部变量数组 b. 操作数栈 c. 动态链接</p> </li> </ol> <p>Heap 中存放：</p> <ol> <li> <p>类实例和数组</p> </li> <li> <p>Run-Time Constant Pool</p> </li> <li> <p>Interned Strings</p> </li> <li> <p>Class Statics</p> </li> </ol> <p>Metaspace中存放：</p> <p>类元数据：包括但不限于KClass结构（很重要，可以理解为Java类在虚拟机内部的表示）、方法元数据（包括字节码，方法参数信息）、常量池、注解、方法计数器。。。</p> <h2 id="__comments">评论</h2> <div id="disqus_thread"></div> <script>var disqus_config=function(){this.page.url="https://yongqilei.github.io/java/jvm-breakdown/",this.page.identifier="java/jvm-breakdown/"};if("undefined"==typeof DISQUS){var script=document.createElement("script");script.async=!0,script.src="https://programming-tech-sharing.disqus.com/embed.js",script.setAttribute("data-timestamp",Date.now()),document.body.appendChild(script)}else DISQUS.reset({reload:!0,config:disqus_config})</script> </article> </div> </div> <a href="#" class="md-top md-icon" data-md-component="top" data-md-state="hidden"> <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8v12z"/></svg> 回到页面顶部 </a> </main> <footer class="md-footer"> <nav class="md-footer__inner md-grid" aria-label="页脚"> <a href="../garbage-collector/" class="md-footer__link md-footer__link--prev" aria-label="上一页: Java 垃圾收集器" rel="prev"> <div class="md-footer__button md-icon"> <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg> </div> <div class="md-footer__title"> <div class="md-ellipsis"> <span class="md-footer__direction"> 上一页 </span> Java 垃圾收集器 </div> </div> </a> <a href="../spring-cloud-ribbon/" class="md-footer__link md-footer__link--next" aria-label="下一页: Spring Cloud Ribbon" rel="next"> <div class="md-footer__title"> <div class="md-ellipsis"> <span class="md-footer__direction"> 下一页 </span> Spring Cloud Ribbon </div> </div> <div class="md-footer__button md-icon"> <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M4 11v2h12l-5.5 5.5 1.42 1.42L19.84 12l-7.92-7.92L10.5 5.5 16 11H4z"/></svg> </div> </a> </nav> <div class="md-footer-meta md-typeset"> <div class="md-footer-meta__inner md-grid"> <div class="md-copyright"> <div class="md-copyright__highlight"> Copyright &copy; 2021 - 2022 Eng Learning by Torres </div> Made with <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener"> Material for MkDocs </a> </div> </div> </div> </footer> </div> <div class="md-dialog" data-md-component="dialog"> <div class="md-dialog__inner md-typeset"></div> </div> <script id="__config" type="application/json">{"base": "../..", "features": ["search.suggest", "search.highlight", "search.share", "navigation.tabs", "navigation.instant", "navigation.tracking", "navigation.top", "content.tabs.link"], "search": "../../assets/javascripts/workers/search.361d90f1.min.js", "translations": {"clipboard.copied": "\u5df2\u590d\u5236", "clipboard.copy": "\u590d\u5236", "search.config.lang": "ja", "search.config.pipeline": "trimmer, stemmer", "search.config.separator": "[\\uff0c\\u3002]+", "search.placeholder": "\u641c\u7d22", "search.result.more.one": "\u5728\u8be5\u9875\u4e0a\u8fd8\u6709 1 \u4e2a\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.more.other": "\u5728\u8be5\u9875\u4e0a\u8fd8\u6709 # \u4e2a\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.none": "\u6ca1\u6709\u627e\u5230\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.one": "\u627e\u5230 1 \u4e2a\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.other": "# \u4e2a\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.placeholder": "\u952e\u5165\u4ee5\u5f00\u59cb\u641c\u7d22", "search.result.term.missing": "\u7f3a\u5c11", "select.version.title": "\u9009\u62e9\u5f53\u524d\u7248\u672c"}}</script> <script src="../../assets/javascripts/bundle.289a2a4b.min.js"></script> <script src="../../javascripts/mathjax.js"></script> <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script> <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script> 